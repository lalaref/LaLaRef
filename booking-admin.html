<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é è¨‚ç®¡ç† | LaLaRef æ€¥å–®ç‹</title>
    <link rel="icon" type="image/jpeg" href="lalaref2.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #f5e6d3 0%, #e8d4b8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: linear-gradient(145deg, #f0dcc8, #e8d4b8);
            border-radius: 30px;
            box-shadow: 20px 20px 40px rgba(0,0,0,0.15), -20px -20px 40px rgba(255,255,255,0.7);
        }

        .header h1 {
            font-size: 2.5em;
            color: #5a4a3a;
            margin-bottom: 10px;
        }

        .setup-notice {
            background: linear-gradient(145deg, #ffd700, #ffed4e);
            padding: 30px;
            border-radius: 25px;
            margin-bottom: 30px;
            box-shadow: 15px 15px 30px rgba(0,0,0,0.15), -15px -15px 30px rgba(255,255,255,0.7);
        }

        .setup-notice h3 {
            color: #5a4a3a;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .setup-notice ol {
            margin-left: 20px;
            color: #5a4a3a;
            line-height: 1.8;
        }

        .setup-notice a {
            color: #d4a574;
            font-weight: 700;
        }

        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 15px 30px;
            background: linear-gradient(145deg, #f0dcc8, #e8d4b8);
            border: none;
            border-radius: 20px;
            color: #5a4a3a;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.15), -10px -10px 20px rgba(255,255,255,0.7);
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            transform: translateY(-3px);
        }

        .tab-btn.active {
            background: linear-gradient(145deg, #d4a574, #c89860);
            color: white;
            box-shadow: inset 8px 8px 16px rgba(0,0,0,0.2), inset -8px -8px 16px rgba(255,255,255,0.5);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-box {
            background: linear-gradient(145deg, #f0dcc8, #e8d4b8);
            padding: 40px;
            border-radius: 30px;
            box-shadow: 20px 20px 40px rgba(0,0,0,0.15), -20px -20px 40px rgba(255,255,255,0.7);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #5a4a3a;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(145deg, #f5e6d3, #ede0cc);
            border: none;
            border-radius: 20px;
            font-size: 1em;
            box-shadow: inset 8px 8px 16px rgba(0,0,0,0.1), inset -8px -8px 16px rgba(255,255,255,0.7);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 15px 30px;
            background: linear-gradient(145deg, #d4a574, #c89860);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.15), -10px -10px 20px rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 15px 15px 30px rgba(0,0,0,0.2), -15px -15px 30px rgba(255,255,255,0.6);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #f0dcc8, #e8d4b8);
            color: #5a4a3a;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .booking-list {
            display: grid;
            gap: 20px;
        }

        .booking-item {
            background: linear-gradient(145deg, #f5e6d3, #ede0cc);
            padding: 25px;
            border-radius: 25px;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.1), -10px -10px 20px rgba(255,255,255,0.7);
        }

        .booking-info h3 {
            color: #d4a574;
            font-size: 1.5em;
            margin-bottom: 10px;
            font-weight: 900;
        }

        .booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .booking-detail {
            color: #5a4a3a;
        }

        .booking-detail strong {
            color: #7a6a5a;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .status-confirmed {
            background: #25d366;
            color: white;
        }

        .status-pending {
            background: #ffa500;
            color: white;
        }

        .status-cancelled {
            background: #ff4444;
            color: white;
        }

        .message {
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #25d366;
            color: white;
        }

        .message.error {
            background: #ff4444;
            color: white;
        }

        .generated-code {
            background: linear-gradient(145deg, #d4a574, #c89860);
            color: white;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .generated-code.show {
            display: block;
        }

        .generated-code h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .code-display {
            font-size: 2em;
            font-weight: 900;
            letter-spacing: 3px;
            margin: 15px 0;
        }

        .copy-btn {
            background: white;
            color: #d4a574;
            padding: 10px 25px;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7a6a5a;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .config-input {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 15px;
            border: 2px solid #d4a574;
            font-family: monospace;
            font-size: 0.9em;
        }

        .save-config-btn {
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .booking-details {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ é è¨‚ç®¡ç†ç³»çµ±</h1>
            <p>ä½¿ç”¨ Google Sheets ç®¡ç†çƒè­‰é è¨‚</p>
        </div>

        <div class="setup-notice" id="setup-notice">
            <h3>âš™ï¸ é¦–æ¬¡è¨­å®šæŒ‡å—</h3>
            <ol>
                <li>å‰å¾€ <a href="https://docs.google.com/spreadsheets" target="_blank">Google Sheets</a> å»ºç«‹æ–°è©¦ç®—è¡¨</li>
                <li>åœ¨ç¬¬ä¸€è¡Œè¼¸å…¥æ¬„ä½æ¨™é¡Œï¼šcode | matchDate | matchTime | venue | matchType | refereeCount | contactName | contactPhone | contactEmail | status | paymentStatus | refereeInfo | notes | createdAt</li>
                <li>é»æ“Šã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€</li>
                <li>è¤‡è£½ä¸‹æ–¹ç¨‹å¼ç¢¼ä¸¦è²¼ä¸Šï¼Œç„¶å¾Œé»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ã€â†’ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</li>
                <li>è¨­å®šã€ŒåŸ·è¡Œèº«åˆ†ã€ç‚ºã€Œæˆ‘ã€ï¼Œã€Œèª°å¯ä»¥å­˜å–ã€ç‚ºã€Œä»»ä½•äººã€</li>
                <li>è¤‡è£½éƒ¨ç½²çš„ç¶²å€ä¸¦è²¼åˆ°ä¸‹æ–¹ã€Œè¨­å®šã€åˆ†é </li>
            </ol>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('create')">â• æ–°å¢é è¨‚</button>
            <button class="tab-btn" onclick="switchTab('list')">ğŸ“‹ é è¨‚åˆ—è¡¨</button>
            <button class="tab-btn" onclick="switchTab('quotation')">ğŸ’° å ±åƒ¹å–®</button>
            <button class="tab-btn" onclick="switchTab('invoice')">ğŸ§¾ ç™¼ç¥¨</button>
            <button class="tab-btn" onclick="switchTab('message')">ğŸ“¤ è¨Šæ¯</button>
            <button class="tab-btn" onclick="switchTab('config')">âš™ï¸ è¨­å®š</button>
        </div>

        <!-- Create Booking Tab -->
        <div id="create-tab" class="tab-content active">
            <div class="form-box">
                <div class="message" id="create-message"></div>
                
                <form id="booking-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="match-date">ğŸ“… æ¯”è³½æ—¥æœŸ *</label>
                            <input type="date" id="match-date" name="matchDate" required>
                        </div>

                        <div class="form-group">
                            <label for="match-time">ğŸ• é–‹å§‹æ™‚é–“ *</label>
                            <input type="time" id="match-time" name="matchTime" required>
                        </div>

                        <div class="form-group">
                            <label for="match-end-time">ğŸ• çµæŸæ™‚é–“ *</label>
                            <input type="time" id="match-end-time" name="matchEndTime" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="venue">ğŸ“ æ¯”è³½åœ°é» *</label>
                        <input type="text" id="venue" name="venue" placeholder="ä¾‹å¦‚: ä¹é¾å…¬åœ’é«”è‚²é¤¨" required>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="match-type">ğŸ€ æ¯”è³½é¡å‹ *</label>
                            <select id="match-type" name="matchType" required>
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="5x5">5x5 å…¨å ´</option>
                                <option value="3x3">3x3 åŠå ´</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="referee-count">ğŸ‘¨â€âš–ï¸ çƒè­‰æ•¸é‡ *</label>
                            <select id="referee-count" name="refereeCount" required>
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="1">1 ä½çƒè­‰</option>
                                <option value="2">2 ä½çƒè­‰</option>
                                <option value="3">3 ä½çƒè­‰</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="contact-name">ğŸ‘¤ è¯çµ¡äººå§“å *</label>
                            <input type="text" id="contact-name" name="contactName" required>
                        </div>

                        <div class="form-group">
                            <label for="contact-phone">ğŸ“± è¯çµ¡é›»è©± *</label>
                            <input type="tel" id="contact-phone" name="contactPhone" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="contact-email">ğŸ“§ é›»éƒµåœ°å€</label>
                        <input type="email" id="contact-email" name="contactEmail">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="status">ğŸ“Š é è¨‚ç‹€æ…‹ *</label>
                            <select id="status" name="status" required>
                                <option value="pending">å¾…ç¢ºèª</option>
                                <option value="confirmed">å·²ç¢ºèª</option>
                                <option value="cancelled">å·²å–æ¶ˆ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="payment-status">ğŸ’° ä»˜æ¬¾ç‹€æ…‹ *</label>
                            <select id="payment-status" name="paymentStatus" required>
                                <option value="æœªä»˜æ¬¾">æœªä»˜æ¬¾</option>
                                <option value="å·²ä»˜æ¬¾">å·²ä»˜æ¬¾</option>
                                <option value="éƒ¨åˆ†ä»˜æ¬¾">éƒ¨åˆ†ä»˜æ¬¾</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="referee-info">ğŸ‘¨â€âš–ï¸ çƒè­‰å®‰æ’</label>
                        <input type="text" id="referee-info" name="refereeInfo" placeholder="ä¾‹å¦‚: å¼µä¸‰ã€æå››">
                    </div>

                    <div class="form-group">
                        <label for="notes">ğŸ“ å‚™è¨»</label>
                        <textarea id="notes" name="notes" placeholder="å…¶ä»–å‚™è¨»è³‡æ–™"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">ğŸ”„ é‡è¨­</button>
                        <button type="submit" class="btn">ğŸ’¾ å„²å­˜é è¨‚</button>
                    </div>
                </form>

                <div class="generated-code" id="generated-code">
                    <h3>âœ… é è¨‚å·²å»ºç«‹</h3>
                    <p>æŸ¥è©¢ç·¨è™Ÿï¼š</p>
                    <div class="code-display" id="code-display"></div>
                    <button class="copy-btn" onclick="copyCode()">ğŸ“‹ è¤‡è£½ç·¨è™Ÿ</button>
                    <p style="margin-top: 15px; font-size: 0.9em;">è«‹å°‡æ­¤ç·¨è™Ÿæä¾›çµ¦å®¢æˆ¶æŸ¥è©¢é è¨‚</p>
                </div>
            </div>
        </div>

        <!-- List Bookings Tab -->
        <div id="list-tab" class="tab-content">
            <div class="form-box">
                <div class="message" id="list-message"></div>
                
                <!-- Earnings Summary -->
                <div id="earnings-summary" style="background: linear-gradient(145deg, #d4a574, #c89860); color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; display: none;">
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 0.85em; opacity: 0.9;">ç¸½æ”¶è²»</div>
                            <div style="font-size: 1.5em; font-weight: 900;" id="summary-total-income">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; opacity: 0.9;">ç¸½çƒè­‰è²»ç”¨</div>
                            <div style="font-size: 1.5em; font-weight: 900;" id="summary-total-referee-cost">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; opacity: 0.9;">ç¸½åˆ©æ½¤</div>
                            <div style="font-size: 1.5em; font-weight: 900;" id="summary-total-profit">$0</div>
                        </div>
                    </div>
                </div>
                
                <div class="booking-list" id="booking-list">
                    <div class="empty-state">
                        <h3>ğŸ“­ æš«ç„¡é è¨‚è¨˜éŒ„</h3>
                        <p>è«‹å…ˆåœ¨ã€Œè¨­å®šã€åˆ†é é…ç½® Google Sheets</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quotation Tab -->
        <div id="quotation-tab" class="tab-content">
            <div class="form-box">
                <h3 style="margin-bottom: 20px; color: #5a4a3a;">ğŸ’° å»ºç«‹å ±åƒ¹å–®</h3>
                <div class="message" id="quotation-message"></div>
                
                <form id="quotation-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="quote-number">å ±åƒ¹å–®ç·¨è™Ÿ *</label>
                            <input type="text" id="quote-number" name="quoteNumber" placeholder="è‡ªå‹•ç”Ÿæˆæˆ–æ‰‹å‹•è¼¸å…¥" required>
                        </div>
                        <div class="form-group">
                            <label for="quote-date">å ±åƒ¹æ—¥æœŸ *</label>
                            <input type="date" id="quote-date" name="quoteDate" required>
                        </div>
                    </div>

                    <h4 style="margin: 30px 0 15px; color: #5a4a3a;">å®¢æˆ¶è³‡æ–™</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customer-name">å®¢æˆ¶å§“å/å…¬å¸åç¨± *</label>
                            <input type="text" id="customer-name" name="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customer-phone">è¯çµ¡é›»è©± *</label>
                            <input type="tel" id="customer-phone" name="customerPhone" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customer-email">é›»éƒµåœ°å€</label>
                        <input type="email" id="customer-email" name="customerEmail">
                    </div>
                    <div class="form-group">
                        <label for="customer-address">åœ°å€</label>
                        <input type="text" id="customer-address" name="customerAddress">
                    </div>

                    <h4 style="margin: 30px 0 15px; color: #5a4a3a;">æœå‹™é …ç›®</h4>
                    <div id="service-items">
                        <div class="service-item" style="background: #f5e6d3; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>æœå‹™åç¨± *</label>
                                    <select class="service-name" required onchange="handleServiceNameChange(this)">
                                        <option value="">è«‹é¸æ“‡</option>
                                        <option value="5x5 å…¨å ´çƒè­‰æœå‹™">5x5 å…¨å ´çƒè­‰æœå‹™</option>
                                        <option value="3x3 åŠå ´çƒè­‰æœå‹™">3x3 åŠå ´çƒè­‰æœå‹™</option>
                                        <option value="å…¶ä»–">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
                                    </select>
                                    <input type="text" class="service-name-custom" placeholder="è«‹è¼¸å…¥æœå‹™åç¨±" style="display: none; margin-top: 10px;">
                                </div>
                                <div class="form-group">
                                    <label>çƒè­‰æ•¸é‡ *</label>
                                    <input type="number" class="service-quantity" min="1" value="1" required>
                                </div>
                                <div class="form-group">
                                    <label>å°æ™‚ *</label>
                                    <input type="number" class="service-hours" min="0.5" step="0.5" value="1" required>
                                </div>
                                <div class="form-group">
                                    <label>å–®åƒ¹ (HKD/å°æ™‚) *</label>
                                    <input type="number" class="service-price" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label>å°è¨ˆ (HKD)</label>
                                    <input type="number" class="service-subtotal" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>å‚™è¨»</label>
                                <input type="text" class="service-notes" placeholder="ä¾‹å¦‚: åŒ…å«2ä½æŒç‰Œçƒè­‰">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addServiceItem()" style="margin-bottom: 20px;">â• æ–°å¢æœå‹™é …ç›®</button>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="discount">æŠ˜æ‰£ (HKD)</label>
                            <input type="number" id="discount" name="discount" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label for="deposit">è¨‚é‡‘ (HKD)</label>
                            <input type="number" id="deposit" name="deposit" min="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label for="total-amount">ç¸½é‡‘é¡ (HKD) *</label>
                            <input type="number" id="total-amount" name="totalAmount" readonly>
                        </div>
                        <div class="form-group">
                            <label for="balance-due">å°¾æ•¸ (HKD)</label>
                            <input type="number" id="balance-due" name="balanceDue" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payment-terms">ä»˜æ¬¾æ¢æ¬¾</label>
                        <textarea id="payment-terms" name="paymentTerms" placeholder="ä¾‹å¦‚: æ¯”è³½ç•¶æ—¥ç¾é‡‘æ”¯ä»˜">ä»˜æ¬¾æ–¹å¼ï¼š
1. PayMe
2. è½‰æ•¸å¿« (FPS)

ä»˜æ¬¾æ™‚é–“ï¼š
- ç¢ºèªè¨‚å–®å¾Œ, é æ”¯ä»˜å…¨æ¬¾</textarea>
                    </div>

                    <div class="form-group">
                        <label for="quote-notes">å‚™è¨»</label>
                        <textarea id="quote-notes" name="quoteNotes" placeholder="å…¶ä»–å‚™è¨»äº‹é …"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="validity-days">å ±åƒ¹æœ‰æ•ˆæœŸ (å¤©)</label>
                        <input type="number" id="validity-days" name="validityDays" value="30" min="1">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetQuotationForm()">ğŸ”„ é‡è¨­</button>
                        <button type="button" class="btn" onclick="previewQuotation()">ğŸ‘ï¸ é è¦½</button>
                        <button type="button" class="btn" onclick="generatePDF()">ğŸ“„ åŒ¯å‡º PDF</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Invoice Tab -->
        <div id="invoice-tab" class="tab-content">
            <div class="form-box">
                <h3 style="margin-bottom: 20px; color: #5a4a3a;">ğŸ§¾ ç™¼ç¥¨ç”Ÿæˆ</h3>
                <div class="message" id="invoice-message"></div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="invoice-quote-number">å ±åƒ¹å–®ç·¨è™Ÿ *</label>
                        <input type="text" id="invoice-quote-number" placeholder="ä¾‹å¦‚: Q20260226001">
                    </div>
                    <div class="form-group">
                        <label for="invoice-date">ç™¼ç¥¨æ—¥æœŸ *</label>
                        <input type="date" id="invoice-date">
                    </div>
                </div>
                <div class="form-group">
                    <label for="invoice-payment-method">ä»˜æ¬¾æ–¹å¼</label>
                    <select id="invoice-payment-method">
                        <option value="PayMe">PayMe</option>
                        <option value="è½‰æ•¸å¿« (FPS)">è½‰æ•¸å¿« (FPS)</option>
                        <option value="éŠ€è¡Œè½‰å¸³">éŠ€è¡Œè½‰å¸³</option>
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="invoice-notes">ç™¼ç¥¨å‚™è¨»</label>
                    <textarea id="invoice-notes" placeholder="å…¶ä»–å‚™è¨»"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="loadQuotationForInvoice()">ğŸ“¥ è¼‰å…¥å ±åƒ¹å–®è³‡æ–™</button>
                    <button type="button" class="btn" onclick="generateInvoicePDF()">ğŸ§¾ åŒ¯å‡ºç™¼ç¥¨ PDF</button>
                </div>
                
                <div id="invoice-preview" style="display:none; margin-top: 20px; padding: 20px; background: #f5e6d3; border-radius: 15px;">
                    <h4 style="color: #5a4a3a; margin-bottom: 10px;">å·²è¼‰å…¥å ±åƒ¹å–®è³‡æ–™ï¼š</h4>
                    <div id="invoice-preview-content"></div>
                </div>
            </div>
        </div>

        <!-- Message Tab -->
        <div id="message-tab" class="tab-content">
            <div class="form-box">
                <h3 style="margin-bottom: 20px; color: #5a4a3a;">ğŸ“¤ å®¢æˆ¶ç¢ºèªè¨Šæ¯</h3>
                <div class="message" id="message-tab-message"></div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="msg-booking-code">é è¨‚ç·¨è™Ÿ *</label>
                        <input type="text" id="msg-booking-code" placeholder="ä¾‹å¦‚: LR20260226001">
                    </div>
                </div>
                <div class="form-actions" style="justify-content: flex-start;">
                    <button type="button" class="btn" onclick="generateMessageFromCode()">ğŸ“¤ ç”Ÿæˆè¨Šæ¯</button>
                </div>
                
                <div id="msg-output-area" style="display:none; margin-top: 20px;">
                    <div class="form-group">
                        <label>ç”Ÿæˆçš„è¨Šæ¯ï¼š</label>
                        <textarea id="msg-output" readonly style="min-height: 300px; font-size: 0.95em; line-height: 1.6; white-space: pre-wrap;"></textarea>
                    </div>
                    <button type="button" class="btn" onclick="copyMessageOutput()">ğŸ“‹ è¤‡è£½è¨Šæ¯</button>
                </div>

                <hr style="border: none; border-top: 2px solid #d4a574; margin: 30px 0;">
                <h3 style="margin-bottom: 20px; color: #5a4a3a;">ğŸ“ å¸¸ç”¨è¨Šæ¯ç¯„æœ¬</h3>

                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="font-weight: 700; color: #5a4a3a;">1. æŸ¥è©¢å›è¦† â€” æœå‹™æ”¶è²»</label>
                        <button type="button" class="btn" style="padding: 8px 18px; font-size: 0.85em;" onclick="copyGreeting(1)">ğŸ“‹ è¤‡è£½</button>
                    </div>
                    <textarea id="greeting-1" readonly style="width:100%; min-height: 320px; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; padding: 15px 20px; background: linear-gradient(145deg, #f5e6d3, #ede0cc); border: none; border-radius: 20px; box-shadow: inset 8px 8px 16px rgba(0,0,0,0.1), inset -8px -8px 16px rgba(255,255,255,0.7);">ä½ å¥½ï¼å¤šè¬æŸ¥è©¢ LaLaRef æ€¥å–®ç‹çƒè­‰æœå‹™ï¼ğŸ€

ğŸ“‹ çƒè­‰æœå‹™æ”¶è²»
* $220/å°æ™‚/çƒè­‰

ğŸ¯ ä¸€æ¢é¾å…¨å¥—æœå‹™
æˆ‘å€‘ä¹Ÿæä¾›å°ˆæ¥­è³½äº‹æœå‹™ï¼š
* æ´»å‹•ç›¸/æ¯”è³½ç›¸ï¼š$200/å°æ™‚
* ç´€éŒ„å°è¨ˆåˆ†ï¼š$120/å°æ™‚
* æ¯”è³½éŒ„å½±ï¼š$80/å°æ™‚
* è¨ˆåˆ†ç‰Œ,è¨ˆåˆ†ç´™,æ‹æ”å™¨æç­‰è¨­å‚™ï¼šå…è²»
* ç¶²ä¸Šæ¯”åˆ†ç´€éŒ„ç³»çµ±
* è³½åˆ¶è¨­è¨ˆåŠå† äºå­£æ±ºå®š

ğŸ’¼ é•·æœŸåˆä½œå„ªæƒ 
æ­¡è¿é•·æœŸåˆä½œï¼Œå¯äº«ç‰¹åˆ¥å„ªæƒ åƒ¹ï¼

è«‹æä¾›ä»¥ä¸‹è³‡æ–™ï¼Œæˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨å®‰æ’ï¼š
ğŸ“… æ¯”è³½æ—¥æœŸåŠæ™‚é–“
ğŸ“ å ´åœ°ä½ç½®
ğŸ€ æ¯”è³½é¡å‹ï¼ˆ5x5 / 3x3ï¼‰
ğŸ‘¥ éœ€è¦çƒè­‰æ•¸ç›®

æœŸå¾…ç‚ºæ‚¨æœå‹™ï¼
LaLaRef æ€¥å–®ç‹ âš¡</textarea>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="font-weight: 700; color: #5a4a3a;">2. è¨‚å–®ç¢ºèª â€” ä»˜æ¬¾æŒ‡å¼•</label>
                        <button type="button" class="btn" style="padding: 8px 18px; font-size: 0.85em;" onclick="copyGreeting(2)">ğŸ“‹ è¤‡è£½</button>
                    </div>
                    <textarea id="greeting-2" readonly style="width:100%; min-height: 220px; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; padding: 15px 20px; background: linear-gradient(145deg, #f5e6d3, #ede0cc); border: none; border-radius: 20px; box-shadow: inset 8px 8px 16px rgba(0,0,0,0.1), inset -8px -8px 16px rgba(255,255,255,0.7);">æ„Ÿè¬ä½ çš„è¨‚å–®ç¢ºèª âœ…

ğŸ’³ ä»˜æ¬¾æ–¹å¼
è«‹é€éä»¥ä¸‹æ–¹å¼æ‚‰æ•¸ä»˜æ¬¾ä»¥ç¢ºèªè¨‚å–®ï¼š
ğŸ”— https://www.lalaref.com/payment.html

æ–¹æ³• 1: PayMe
æ–¹æ³• 2: è½‰æ•¸å¿« (FPS)

âœ… ä»˜æ¬¾å¾Œè«‹åš
1ï¸âƒ£ æˆªåœ–ä»˜æ¬¾è¨˜éŒ„
2ï¸âƒ£ é€é WhatsApp å‚³é€æˆªåœ–

LaLaRef æ€¥å–®ç‹ âš¡</textarea>
                </div>

            </div>
        </div>

        <!-- Config Tab -->
        <div id="config-tab" class="tab-content">
            <div class="form-box">
                <h3 style="margin-bottom: 20px; color: #5a4a3a;">âš™ï¸ Google Sheets è¨­å®š</h3>
                <div class="message" id="config-message"></div>
                
                <div class="form-group">
                    <label for="sheet-url">Google Apps Script ç¶²å€</label>
                    <input type="url" id="sheet-url" class="config-input" placeholder="https://script.google.com/macros/s/...../exec">
                    <button class="btn save-config-btn" onclick="saveConfig()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f5e6d3; border-radius: 15px;">
                    <h4 style="margin-bottom: 15px; color: #5a4a3a;">ğŸ“ Google Apps Script ç¨‹å¼ç¢¼</h4>
                    <p style="margin-bottom: 10px; color: #7a6a5a;">è¤‡è£½ä»¥ä¸‹ç¨‹å¼ç¢¼åˆ° Google Sheets çš„ Apps Scriptï¼š</p>
                    <textarea readonly style="width: 100%; height: 500px; font-family: monospace; font-size: 0.85em; padding: 10px; border-radius: 10px; border: 1px solid #d4a574;">
function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Bookings') || ss.getActiveSheet();
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1);
  
  const code = e.parameter.code;
  const action = e.parameter.action;
  
  // Get admin data
  if (action === 'getAdminData') {
    const adminSheet = ss.getSheetByName('AdminData');
    if (!adminSheet) return ContentService.createTextOutput(JSON.stringify({success: true, adminData: {}})).setMimeType(ContentService.MimeType.JSON);
    const adminData = adminSheet.getDataRange().getValues();
    if (adminData.length <= 1) return ContentService.createTextOutput(JSON.stringify({success: true, adminData: {}})).setMimeType(ContentService.MimeType.JSON);
    const result = {};
    for (let i = 1; i < adminData.length; i++) {
      result[adminData[i][0]] = {
        removed: adminData[i][1] === true || adminData[i][1] === 'true',
        totalCost: adminData[i][2] || '',
        refereeCost: adminData[i][3] || '',
        refereeInfo: adminData[i][4] || '',
        status: adminData[i][5] || '',
        paymentStatus: adminData[i][6] || '',
        venue: adminData[i][7] || '',
        notes: adminData[i][8] || ''
      };
    }
    return ContentService.createTextOutput(JSON.stringify({success: true, adminData: result})).setMimeType(ContentService.MimeType.JSON);
  }
  
  if (code) {
    const booking = rows.find(row => row[0] === code);
    if (booking) {
      const result = {};
      headers.forEach((header, i) => result[header] = booking[i]);
      return ContentService.createTextOutput(JSON.stringify({success: true, booking: result})).setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(JSON.stringify({success: false, message: 'æ‰¾ä¸åˆ°æ­¤é è¨‚ç·¨è™Ÿ'})).setMimeType(ContentService.MimeType.JSON);
  }
  
  const bookings = rows.map(row => {
    const obj = {};
    headers.forEach((header, i) => obj[header] = row[i]);
    return obj;
  });
  
  return ContentService.createTextOutput(JSON.stringify({success: true, bookings: bookings})).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const data = JSON.parse(e.postData.contents);
  
  // Save admin data (edits, removals, profit)
  if (data.action === 'saveAdminData') {
    let adminSheet = ss.getSheetByName('AdminData');
    if (!adminSheet) {
      adminSheet = ss.insertSheet('AdminData');
      adminSheet.appendRow(['code', 'removed', 'totalCost', 'refereeCost', 'refereeInfo', 'status', 'paymentStatus', 'venue', 'notes']);
    }
    const adminData = adminSheet.getDataRange().getValues();
    let rowIndex = -1;
    for (let i = 1; i < adminData.length; i++) {
      if (adminData[i][0] === data.code) { rowIndex = i + 1; break; }
    }
    const rowData = [data.code, data.removed || false, data.totalCost || '', data.refereeCost || '', data.refereeInfo || '', data.status || '', data.paymentStatus || '', data.venue || '', data.notes || ''];
    if (rowIndex > 0) {
      adminSheet.getRange(rowIndex, 1, 1, rowData.length).setValues([rowData]);
    } else {
      adminSheet.appendRow(rowData);
    }
    return ContentService.createTextOutput(JSON.stringify({success: true, message: 'å·²å„²å­˜'})).setMimeType(ContentService.MimeType.JSON);
  }
  
  const sheet = ss.getSheetByName('Bookings') || ss.getActiveSheet();
  sheet.appendRow([
    data.code,
    data.matchDate,
    data.matchTime,
    data.matchEndTime,
    data.venue,
    data.matchType,
    data.refereeCount,
    data.contactName,
    data.contactPhone,
    data.contactEmail || '',
    data.status,
    data.paymentStatus,
    data.refereeInfo || '',
    data.notes || '',
    new Date().toISOString()
  ]);
  
  return ContentService.createTextOutput(JSON.stringify({success: true, message: 'é è¨‚å·²å»ºç«‹'})).setMimeType(ContentService.MimeType.JSON);
}
</textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sheetUrl = localStorage.getItem('sheetUrl') || '';
        let editingId = null;

        // IMPORTANT: Set your Google Sheets URL here for production
        // This will be used if localStorage is empty (e.g., on external devices)
        const FALLBACK_SHEET_URL = 'https://script.google.com/macros/s/AKfycbx2xeJ7WZUwf5kXr9wTOYR5udv0vhHuu3HlIE5HTbGFgRZ7XhIt-O3Xg7PnM8dB6U6MZg/exec';
        
        // Use fallback if localStorage is empty
        if (!sheetUrl && FALLBACK_SHEET_URL) {
            sheetUrl = FALLBACK_SHEET_URL;
            localStorage.setItem('sheetUrl', FALLBACK_SHEET_URL);
        }
        
        if (sheetUrl) {
            document.getElementById('sheet-url').value = sheetUrl;
            document.getElementById('setup-notice').style.display = 'none';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'create') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('create-tab').classList.add('active');
            } else if (tab === 'list') {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('list-tab').classList.add('active');
                loadBookings();
            } else if (tab === 'quotation') {
                document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
                document.getElementById('quotation-tab').classList.add('active');
                initQuotationForm();
            } else if (tab === 'invoice') {
                document.querySelector('.tab-btn:nth-child(4)').classList.add('active');
                document.getElementById('invoice-tab').classList.add('active');
                document.getElementById('invoice-date').valueAsDate = new Date();
            } else if (tab === 'message') {
                document.querySelector('.tab-btn:nth-child(5)').classList.add('active');
                document.getElementById('message-tab').classList.add('active');
            } else if (tab === 'config') {
                document.querySelector('.tab-btn:nth-child(6)').classList.add('active');
                document.getElementById('config-tab').classList.add('active');
            }
        }

        function saveConfig() {
            const url = document.getElementById('sheet-url').value.trim();
            if (!url) {
                showMessage('config-message', 'è«‹è¼¸å…¥ Google Apps Script ç¶²å€', 'error');
                return;
            }
            
            localStorage.setItem('sheetUrl', url);
            sheetUrl = url;
            showMessage('config-message', 'è¨­å®šå·²å„²å­˜', 'success');
            document.getElementById('setup-notice').style.display = 'none';
        }

        document.getElementById('booking-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!sheetUrl) {
                showMessage('create-message', 'è«‹å…ˆåœ¨ã€Œè¨­å®šã€åˆ†é é…ç½® Google Sheets', 'error');
                return;
            }
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            data.code = generateBookingCode();
            data.createdAt = new Date().toISOString();
            
            try {
                const response = await fetch(sheetUrl, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('create-message', result.message, 'success');
                    document.getElementById('code-display').textContent = data.code;
                    document.getElementById('generated-code').classList.add('show');
                    
                    // Don't auto-reset, let user manually reset or switch tabs
                } else {
                    showMessage('create-message', result.message || 'å„²å­˜å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('create-message', 'å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Google Sheets è¨­å®š', 'error');
            }
        });

        function generateBookingCode() {
            const today = new Date();
            const dateStr = today.getFullYear() + 
                          String(today.getMonth() + 1).padStart(2, '0') + 
                          String(today.getDate()).padStart(2, '0');
            const randomNum = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            return 'LR' + dateStr + randomNum;
        }

        // Global admin data cache (from Google Sheets)
        let adminDataCache = {};

        async function syncAdminToSheet(code, data) {
            if (!sheetUrl) return;
            try {
                const response = await fetch(sheetUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveAdminData', code: code, ...data }),
                    redirect: 'follow'
                });
                // Google Apps Script redirects, response may not be JSON
                try {
                    const result = await response.json();
                    return result;
                } catch(e) { return { success: true }; }
            } catch(e) {
                console.warn('Sync to sheet failed for ' + code, e);
            }
        }

        async function loadBookings() {
            if (!sheetUrl) {
                document.getElementById('booking-list').innerHTML = `
                    <div class="empty-state">
                        <h3>âš™ï¸ è«‹å…ˆè¨­å®š Google Sheets</h3>
                        <p>å‰å¾€ã€Œè¨­å®šã€åˆ†é é…ç½®é€£æ¥</p>
                    </div>
                `;
                return;
            }
            
            try {
                const bookingsRes = await fetch(sheetUrl);
                const data = await bookingsRes.json();
                
                if (data.success && data.bookings) {
                    // Render immediately using localStorage data
                    renderBookings(data.bookings);
                    
                    // Then try to sync admin data from Google Sheets in background (don't await)
                    fetchAdminDataInBackground();
                } else {
                    showMessage('list-message', 'è¼‰å…¥å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                showMessage('list-message', 'è¼‰å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        function fetchAdminDataInBackground() {
            fetch(sheetUrl + '?action=getAdminData')
                .then(res => res.text())
                .then(text => {
                    try {
                        const adminResult = JSON.parse(text);
                        if (adminResult.success && adminResult.adminData && typeof adminResult.adminData === 'object') {
                            adminDataCache = adminResult.adminData;
                            const profitData = {};
                            const removedBookings = [];
                            const bookingEdits = {};
                            for (const [code, ad] of Object.entries(adminDataCache)) {
                                if (ad.removed) removedBookings.push(code);
                                if (ad.totalCost || ad.refereeCost) profitData[code] = { totalCost: ad.totalCost, refereeCost: ad.refereeCost };
                                if (ad.refereeInfo || ad.status || ad.paymentStatus || ad.venue || ad.notes) {
                                    const edits = {};
                                    if (ad.refereeInfo) edits.refereeInfo = ad.refereeInfo;
                                    if (ad.status) edits.status = ad.status;
                                    if (ad.paymentStatus) edits.paymentStatus = ad.paymentStatus;
                                    if (ad.venue) edits.venue = ad.venue;
                                    if (ad.notes) edits.notes = ad.notes;
                                    if (Object.keys(edits).length > 0) bookingEdits[code] = edits;
                                }
                            }
                            localStorage.setItem('bookingProfitData', JSON.stringify(profitData));
                            localStorage.setItem('removedBookings', JSON.stringify(removedBookings));
                            localStorage.setItem('bookingEdits', JSON.stringify(bookingEdits));
                        }
                    } catch(e) {}
                })
                .catch(() => {});
        }

        function renderBookings(bookings) {
          try {
            const listContainer = document.getElementById('booking-list');
            const summaryEl = document.getElementById('earnings-summary');
            
            if (bookings.length === 0 || bookings.filter(b => b.code && String(b.code).trim() !== '').length === 0) {
                listContainer.innerHTML = '<div class="empty-state"><h3>ğŸ“­ æš«ç„¡é è¨‚è¨˜éŒ„</h3><p>è«‹æ–°å¢ç¬¬ä¸€å€‹é è¨‚</p></div>';
                summaryEl.style.display = 'none';
                return;
            }
            
            const profitData = JSON.parse(localStorage.getItem('bookingProfitData') || '{}');
            const removedBookings = JSON.parse(localStorage.getItem('removedBookings') || '[]');
            const bookingEdits = JSON.parse(localStorage.getItem('bookingEdits') || '{}');
            const validBookings = bookings.filter(b => b.code && String(b.code).trim() !== '' && !removedBookings.includes(String(b.code)));
            
            // Apply local edits
            validBookings.forEach(b => {
                b.code = String(b.code);
                const edits = bookingEdits[b.code];
                if (edits) {
                    if (edits.refereeInfo !== undefined) b.refereeInfo = edits.refereeInfo;
                    if (edits.status !== undefined) b.status = edits.status;
                    if (edits.paymentStatus !== undefined) b.paymentStatus = edits.paymentStatus;
                    if (edits.venue !== undefined) b.venue = edits.venue;
                    if (edits.notes !== undefined) b.notes = edits.notes;
                }
            });
            const sortedBookings = [...validBookings].reverse();
            
            summaryEl.style.display = 'block';
            
            listContainer.innerHTML = sortedBookings.map(booking => {
                const code = booking.code || '';
                const saved = profitData[code] || {};
                const tc = saved.totalCost || '';
                const rc = saved.refereeCost || '';
                const profit = (parseFloat(tc) || 0) - (parseFloat(rc) || 0);
                const profitColor = profit > 0 ? '#25d366' : profit < 0 ? '#ff4444' : '#5a4a3a';
                
                return `
                <div class="booking-item" id="booking-${code}" style="position:relative;">
                    <button onclick="removeBooking('${code}')" style="position:absolute;top:12px;right:12px;background:#ff4444;color:white;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-weight:bold;font-size:1em;line-height:28px;text-align:center;box-shadow:3px 3px 6px rgba(0,0,0,0.15);" title="ç§»é™¤æ­¤é è¨‚">Ã—</button>
                    <div class="booking-info">
                        <h3>${code || 'N/A'}<span class="status-badge status-${booking.status || 'pending'}">${getStatusText(booking.status)}</span></h3>
                        <div class="booking-details">
                            <div class="booking-detail"><strong>æ—¥æœŸï¼š</strong>${formatDate(booking.matchDate)}</div>
                            <div class="booking-detail"><strong>é–‹å§‹æ™‚é–“ï¼š</strong>${formatTime(booking.matchTime)}</div>
                            <div class="booking-detail"><strong>çµæŸæ™‚é–“ï¼š</strong>${formatTime(booking.matchEndTime)}</div>
                            <div class="booking-detail"><strong>åœ°é»ï¼š</strong>${booking.venue || 'N/A'}</div>
                            <div class="booking-detail"><strong>é¡å‹ï¼š</strong>${booking.matchType || 'N/A'}</div>
                            <div class="booking-detail"><strong>è¯çµ¡äººï¼š</strong>${booking.contactName || 'N/A'}</div>
                            <div class="booking-detail"><strong>é›»è©±ï¼š</strong>${booking.contactPhone || 'N/A'}</div>
                            <div class="booking-detail"><strong>ä»˜æ¬¾ï¼š</strong>${booking.paymentStatus || 'N/A'}</div>
                            ${booking.refereeInfo ? `<div class="booking-detail"><strong>çƒè­‰ï¼š</strong>${booking.refereeInfo}</div>` : `<div class="booking-detail"><strong>çƒè­‰ï¼š</strong><span style="color:#999;">æœªå®‰æ’</span></div>`}
                            ${booking.notes ? `<div class="booking-detail" style="grid-column:1/-1;"><strong>å‚™è¨»ï¼š</strong>${booking.notes}</div>` : ''}
                        </div>
                        <button onclick="toggleEdit('${code}')" style="margin-top:10px;padding:6px 16px;background:linear-gradient(145deg,#f0dcc8,#e8d4b8);border:none;border-radius:12px;color:#5a4a3a;font-size:0.85em;font-weight:700;cursor:pointer;box-shadow:4px 4px 8px rgba(0,0,0,0.1),-4px -4px 8px rgba(255,255,255,0.7);">âœï¸ ç·¨è¼¯</button>
                        <div id="edit-${code}" style="display:none;margin-top:12px;padding:15px;background:linear-gradient(145deg,#f5e6d3,#ede0cc);border-radius:15px;">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
                                <div>
                                    <label style="font-size:0.8em;color:#7a6a5a;display:block;margin-bottom:4px;">ğŸ‘¨â€âš–ï¸ çƒè­‰å®‰æ’</label>
                                    <input type="text" id="edit-referee-${code}" value="${(booking.refereeInfo || '').replace(/"/g, '&quot;')}" placeholder="ä¾‹å¦‚: å¼µä¸‰ã€æå››" style="width:100%;padding:8px 10px;border:none;border-radius:12px;background:white;font-size:0.9em;">
                                </div>
                                <div>
                                    <label style="font-size:0.8em;color:#7a6a5a;display:block;margin-bottom:4px;">ğŸ“Š é è¨‚ç‹€æ…‹</label>
                                    <select id="edit-status-${code}" style="width:100%;padding:8px 10px;border:none;border-radius:12px;background:white;font-size:0.9em;">
                                        <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>å¾…ç¢ºèª</option>
                                        <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>å·²ç¢ºèª</option>
                                        <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>å·²å–æ¶ˆ</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:0.8em;color:#7a6a5a;display:block;margin-bottom:4px;">ğŸ’° ä»˜æ¬¾ç‹€æ…‹</label>
                                    <select id="edit-payment-${code}" style="width:100%;padding:8px 10px;border:none;border-radius:12px;background:white;font-size:0.9em;">
                                        <option value="æœªä»˜æ¬¾" ${booking.paymentStatus === 'æœªä»˜æ¬¾' ? 'selected' : ''}>æœªä»˜æ¬¾</option>
                                        <option value="å·²ä»˜æ¬¾" ${booking.paymentStatus === 'å·²ä»˜æ¬¾' ? 'selected' : ''}>å·²ä»˜æ¬¾</option>
                                        <option value="éƒ¨åˆ†ä»˜æ¬¾" ${booking.paymentStatus === 'éƒ¨åˆ†ä»˜æ¬¾' ? 'selected' : ''}>éƒ¨åˆ†ä»˜æ¬¾</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:0.8em;color:#7a6a5a;display:block;margin-bottom:4px;">ğŸ“ åœ°é»</label>
                                    <input type="text" id="edit-venue-${code}" value="${(booking.venue || '').replace(/"/g, '&quot;')}" style="width:100%;padding:8px 10px;border:none;border-radius:12px;background:white;font-size:0.9em;">
                                </div>
                            </div>
                            <div style="margin-top:10px;">
                                <label style="font-size:0.8em;color:#7a6a5a;display:block;margin-bottom:4px;">ğŸ“ å‚™è¨»</label>
                                <input type="text" id="edit-notes-${code}" value="${(booking.notes || '').replace(/"/g, '&quot;')}" placeholder="å‚™è¨»" style="width:100%;padding:8px 10px;border:none;border-radius:12px;background:white;font-size:0.9em;">
                            </div>
                            <button onclick="saveBookingEdit('${code}')" style="margin-top:10px;padding:8px 20px;background:linear-gradient(145deg,#d4a574,#c89860);border:none;border-radius:12px;color:white;font-weight:700;cursor:pointer;font-size:0.9em;">ğŸ’¾ å„²å­˜</button>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: linear-gradient(145deg, #e8d4b8, #dcc8a8); border-radius: 15px;">
                            <div style="font-weight: 700; color: #5a4a3a; margin-bottom: 10px; font-size: 0.95em;">ğŸ’° åˆ©æ½¤è¨ˆç®—</div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 110px;">
                                    <label style="font-size: 0.8em; color: #7a6a5a; display: block; margin-bottom: 4px;">æ”¶è²» (HKD)</label>
                                    <input type="number" class="profit-total-cost" data-code="${code}" value="${tc}" placeholder="0" min="0" step="0.01" oninput="updateProfit('${code}')" style="width:100%;padding:8px 10px;border:none;border-radius:12px;background:linear-gradient(145deg,#f5e6d3,#ede0cc);box-shadow:inset 4px 4px 8px rgba(0,0,0,0.1),inset -4px -4px 8px rgba(255,255,255,0.7);font-size:0.95em;">
                                </div>
                                <div style="padding-top:18px;color:#7a6a5a;">âˆ’</div>
                                <div style="flex: 1; min-width: 110px;">
                                    <label style="font-size: 0.8em; color: #7a6a5a; display: block; margin-bottom: 4px;">çƒè­‰è²»ç”¨ (HKD)</label>
                                    <input type="number" class="profit-referee-cost" data-code="${code}" value="${rc}" placeholder="0" min="0" step="0.01" oninput="updateProfit('${code}')" style="width:100%;padding:8px 10px;border:none;border-radius:12px;background:linear-gradient(145deg,#f5e6d3,#ede0cc);box-shadow:inset 4px 4px 8px rgba(0,0,0,0.1),inset -4px -4px 8px rgba(255,255,255,0.7);font-size:0.95em;">
                                </div>
                                <div style="padding-top:18px;color:#7a6a5a;">=</div>
                                <div style="flex: 1; min-width: 110px;">
                                    <label style="font-size: 0.8em; color: #7a6a5a; display: block; margin-bottom: 4px;">åˆ©æ½¤ (HKD)</label>
                                    <div class="profit-result" data-code="${code}" style="padding:8px 10px;border-radius:12px;background:rgba(255,255,255,0.5);font-weight:900;font-size:1.1em;color:${profitColor};text-align:center;">$${profit.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            updateEarningsSummary();
          } catch(err) {
            console.error('renderBookings error:', err);
            document.getElementById('booking-list').innerHTML = '<div class="empty-state"><h3>âš ï¸ é¡¯ç¤ºéŒ¯èª¤</h3><p>' + err.message + '</p></div>';
          }
        }

        function removeBooking(code) {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤é è¨‚ ' + code + ' å—ï¼Ÿ')) return;
            const removed = JSON.parse(localStorage.getItem('removedBookings') || '[]');
            if (!removed.includes(code)) removed.push(code);
            localStorage.setItem('removedBookings', JSON.stringify(removed));
            const el = document.getElementById('booking-' + code);
            if (el) el.remove();
            updateEarningsSummary();
            syncAdminToSheet(code, { removed: true });
        }

        function toggleEdit(code) {
            const el = document.getElementById('edit-' + code);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function saveBookingEdit(code) {
            const edits = JSON.parse(localStorage.getItem('bookingEdits') || '{}');
            edits[code] = {
                refereeInfo: document.getElementById('edit-referee-' + code).value,
                status: document.getElementById('edit-status-' + code).value,
                paymentStatus: document.getElementById('edit-payment-' + code).value,
                venue: document.getElementById('edit-venue-' + code).value,
                notes: document.getElementById('edit-notes-' + code).value
            };
            localStorage.setItem('bookingEdits', JSON.stringify(edits));
            showMessage('list-message', 'é è¨‚ ' + code + ' å·²æ›´æ–°', 'success');
            
            // Re-render from localStorage immediately
            loadBookings();
            
            // Sync to Google Sheets in background
            const profitData = JSON.parse(localStorage.getItem('bookingProfitData') || '{}');
            const pd = profitData[code] || {};
            syncAdminToSheet(code, { ...edits[code], totalCost: pd.totalCost || '', refereeCost: pd.refereeCost || '' });
        }

        let profitSyncTimers = {};
        function updateProfit(code) {
            const tcInput = document.querySelector(`.profit-total-cost[data-code="${code}"]`);
            const rcInput = document.querySelector(`.profit-referee-cost[data-code="${code}"]`);
            const resultEl = document.querySelector(`.profit-result[data-code="${code}"]`);
            
            const tc = parseFloat(tcInput.value) || 0;
            const rc = parseFloat(rcInput.value) || 0;
            const profit = tc - rc;
            
            resultEl.textContent = '$' + profit.toFixed(2);
            resultEl.style.color = profit > 0 ? '#25d366' : profit < 0 ? '#ff4444' : '#5a4a3a';
            
            // Save to localStorage
            const profitData = JSON.parse(localStorage.getItem('bookingProfitData') || '{}');
            profitData[code] = { totalCost: tcInput.value, refereeCost: rcInput.value };
            localStorage.setItem('bookingProfitData', JSON.stringify(profitData));
            
            updateEarningsSummary();
            
            // Debounced sync to Google Sheets (1.5s after last keystroke)
            clearTimeout(profitSyncTimers[code]);
            profitSyncTimers[code] = setTimeout(() => {
                const edits = JSON.parse(localStorage.getItem('bookingEdits') || '{}');
                const ed = edits[code] || {};
                syncAdminToSheet(code, { ...ed, totalCost: tcInput.value, refereeCost: rcInput.value });
            }, 1500);
        }

        function updateEarningsSummary() {
            let totalIncome = 0, totalRefCost = 0;
            document.querySelectorAll('.profit-total-cost').forEach(input => {
                totalIncome += parseFloat(input.value) || 0;
            });
            document.querySelectorAll('.profit-referee-cost').forEach(input => {
                totalRefCost += parseFloat(input.value) || 0;
            });
            const totalProfit = totalIncome - totalRefCost;
            
            document.getElementById('summary-total-income').textContent = '$' + totalIncome.toFixed(2);
            document.getElementById('summary-total-referee-cost').textContent = '$' + totalRefCost.toFixed(2);
            const profitEl = document.getElementById('summary-total-profit');
            profitEl.textContent = '$' + totalProfit.toFixed(2);
            profitEl.style.color = totalProfit >= 0 ? 'white' : '#ffcccc';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…ç¢ºèª',
                'confirmed': 'å·²ç¢ºèª',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        function formatTime(timeValue) {
            if (!timeValue) return 'N/A';
            
            // If it's already in HH:MM format, return as is
            if (typeof timeValue === 'string' && /^\d{2}:\d{2}$/.test(timeValue)) {
                return timeValue;
            }
            
            // If it's a date string from Google Sheets
            if (typeof timeValue === 'string' && timeValue.includes('T')) {
                const date = new Date(timeValue);
                // Use local time instead of UTC to get correct hours
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            
            return timeValue;
        }

        function formatDate(dateValue) {
            if (!dateValue) return 'N/A';
            
            // If it's already in YYYY-MM-DD format, return as is
            if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                return dateValue;
            }
            
            // If it's a date string from Google Sheets
            if (typeof dateValue === 'string' && dateValue.includes('T')) {
                const date = new Date(dateValue);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // If it's a Date object
            if (dateValue instanceof Date) {
                const year = dateValue.getFullYear();
                const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                const day = String(dateValue.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return dateValue;
        }

        function resetForm() {
            document.getElementById('booking-form').reset();
            document.getElementById('generated-code').classList.remove('show');
            document.getElementById('create-message').classList.remove('show');
        }

        function copyCode() {
            const code = document.getElementById('code-display').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('ç·¨è™Ÿå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            });
        }

        function showMessage(elementId, message, type) {
            const msgElement = document.getElementById(elementId);
            msgElement.textContent = message;
            msgElement.className = 'message show ' + type;
            
            setTimeout(() => {
                msgElement.classList.remove('show');
            }, 5000);
        }

        // Quotation Functions
        function initQuotationForm() {
            // Generate quote number
            const today = new Date();
            const dateStr = today.getFullYear() + 
                          String(today.getMonth() + 1).padStart(2, '0') + 
                          String(today.getDate()).padStart(2, '0');
            const randomNum = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            document.getElementById('quote-number').value = 'Q' + dateStr + randomNum;
            
            // Set today's date
            document.getElementById('quote-date').valueAsDate = new Date();
            
            // Add event listeners for calculation
            updateCalculations();
        }

        function addServiceItem() {
            const container = document.getElementById('service-items');
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.style.cssText = 'background: #f5e6d3; padding: 20px; border-radius: 15px; margin-bottom: 15px; position: relative;';
            newItem.innerHTML = `
                <button type="button" onclick="removeServiceItem(this)" style="position: absolute; top: 10px; right: 10px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold;">Ã—</button>
                <div class="form-grid">
                    <div class="form-group">
                        <label>æœå‹™åç¨± *</label>
                        <select class="service-name" required onchange="handleServiceNameChange(this)">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="5x5 å…¨å ´çƒè­‰æœå‹™">5x5 å…¨å ´çƒè­‰æœå‹™</option>
                            <option value="3x3 åŠå ´çƒè­‰æœå‹™">3x3 åŠå ´çƒè­‰æœå‹™</option>
                            <option value="å…¶ä»–">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
                        </select>
                        <input type="text" class="service-name-custom" placeholder="è«‹è¼¸å…¥æœå‹™åç¨±" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>çƒè­‰æ•¸é‡ *</label>
                        <input type="number" class="service-quantity" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label>å°æ™‚ *</label>
                        <input type="number" class="service-hours" min="0.5" step="0.5" value="1" required>
                    </div>
                    <div class="form-group">
                        <label>å–®åƒ¹ (HKD/å°æ™‚) *</label>
                        <input type="number" class="service-price" min="0" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>å°è¨ˆ (HKD)</label>
                        <input type="number" class="service-subtotal" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <input type="text" class="service-notes" placeholder="ä¾‹å¦‚: åŒ…å«2ä½æŒç‰Œçƒè­‰">
                </div>
            `;
            container.appendChild(newItem);
            updateCalculations();
        }

        function handleServiceNameChange(selectElement) {
            const serviceItem = selectElement.closest('.service-item');
            const customInput = serviceItem.querySelector('.service-name-custom');
            
            if (selectElement.value === 'å…¶ä»–') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        function removeServiceItem(btn) {
            btn.parentElement.remove();
            updateCalculations();
        }

        function updateCalculations() {
            // Add event listeners to all service items
            document.querySelectorAll('.service-quantity, .service-hours, .service-price').forEach(input => {
                input.removeEventListener('input', calculateSubtotals);
                input.addEventListener('input', calculateSubtotals);
            });
            
            document.getElementById('discount').removeEventListener('input', calculateTotal);
            document.getElementById('discount').addEventListener('input', calculateTotal);
            
            document.getElementById('deposit').removeEventListener('input', calculateBalance);
            document.getElementById('deposit').addEventListener('input', calculateBalance);
            
            calculateSubtotals();
        }

        function calculateSubtotals() {
            document.querySelectorAll('.service-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.service-quantity').value) || 0;
                const hours = parseFloat(item.querySelector('.service-hours').value) || 0;
                const price = parseFloat(item.querySelector('.service-price').value) || 0;
                const subtotal = quantity * hours * price;
                item.querySelector('.service-subtotal').value = subtotal.toFixed(2);
            });
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.service-subtotal').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const finalTotal = Math.max(0, total - discount);
            document.getElementById('total-amount').value = finalTotal.toFixed(2);
            
            calculateBalance();
        }

        function calculateBalance() {
            const total = parseFloat(document.getElementById('total-amount').value) || 0;
            const deposit = parseFloat(document.getElementById('deposit').value) || 0;
            const balance = Math.max(0, total - deposit);
            document.getElementById('balance-due').value = balance.toFixed(2);
        }

        function resetQuotationForm() {
            document.getElementById('quotation-form').reset();
            // Keep only one service item
            const container = document.getElementById('service-items');
            const items = container.querySelectorAll('.service-item');
            for (let i = 1; i < items.length; i++) {
                items[i].remove();
            }
            initQuotationForm();
        }

        function previewQuotation() {
            const data = getQuotationData();
            if (!data) return;
            
            alert('å ±åƒ¹å–®é è¦½\n\n' + 
                  'å ±åƒ¹å–®ç·¨è™Ÿ: ' + data.quoteNumber + '\n' +
                  'å®¢æˆ¶: ' + data.customerName + '\n' +
                  'ç¸½é‡‘é¡: HKD $' + data.totalAmount + '\n\n' +
                  'è«‹é»æ“Šã€ŒåŒ¯å‡º PDFã€ç”Ÿæˆå®Œæ•´å ±åƒ¹å–®');
        }

        function getQuotationData() {
            const form = document.getElementById('quotation-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return null;
            }
            
            const services = [];
            document.querySelectorAll('.service-item').forEach(item => {
                const selectElement = item.querySelector('.service-name');
                const customInput = item.querySelector('.service-name-custom');
                let serviceName = selectElement.value;
                
                // If "å…¶ä»–" is selected, use custom input value
                if (serviceName === 'å…¶ä»–') {
                    serviceName = customInput.value || 'å…¶ä»–æœå‹™';
                }
                
                services.push({
                    name: serviceName,
                    quantity: item.querySelector('.service-quantity').value,
                    hours: item.querySelector('.service-hours').value,
                    price: item.querySelector('.service-price').value,
                    subtotal: item.querySelector('.service-subtotal').value,
                    notes: item.querySelector('.service-notes').value
                });
            });
            
            return {
                quoteNumber: document.getElementById('quote-number').value,
                quoteDate: document.getElementById('quote-date').value,
                customerName: document.getElementById('customer-name').value,
                customerPhone: document.getElementById('customer-phone').value,
                customerEmail: document.getElementById('customer-email').value,
                customerAddress: document.getElementById('customer-address').value,
                services: services,
                discount: document.getElementById('discount').value,
                deposit: document.getElementById('deposit').value,
                totalAmount: document.getElementById('total-amount').value,
                balanceDue: document.getElementById('balance-due').value,
                paymentTerms: document.getElementById('payment-terms').value,
                quoteNotes: document.getElementById('quote-notes').value,
                validityDays: document.getElementById('validity-days').value
            };
        }

        async function generatePDF() {
            const data = getQuotationData();
            if (!data) return;
            
            // Save quotation data to localStorage for invoice generation
            const savedQuotations = JSON.parse(localStorage.getItem('savedQuotations') || '{}');
            savedQuotations[data.quoteNumber] = data;
            localStorage.setItem('savedQuotations', JSON.stringify(savedQuotations));
            
            // Helper function to format money with thousand separators
            const formatMoney = (amount) => {
                return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            };
            
            // Load and convert logo to base64
            let logoBase64 = '';
            try {
                const logoImg = new Image();
                // Don't use crossOrigin for same-domain images
                await new Promise((resolve, reject) => {
                    logoImg.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = logoImg.width;
                            canvas.height = logoImg.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(logoImg, 0, 0);
                            logoBase64 = canvas.toDataURL('image/jpeg');
                            resolve();
                        } catch (err) {
                            console.warn('Canvas conversion failed:', err);
                            resolve(); // Continue without logo
                        }
                    };
                    logoImg.onerror = () => {
                        console.warn('Logo loading failed');
                        resolve(); // Continue without logo if fails
                    };
                    // Use correct file extension
                    logoImg.src = 'lalaref2.jpg';
                });
            } catch (error) {
                console.warn('Logo loading failed, continuing without logo:', error);
            }
            
            // Create a temporary HTML element for PDF generation
            const pdfContainer = document.createElement('div');
            pdfContainer.style.cssText = 'position: absolute; left: -9999px; width: 800px; background: white; padding: 40px; font-family: Arial, sans-serif;';
            
            // Calculate validity date
            const validUntil = new Date(data.quoteDate);
            validUntil.setDate(validUntil.getDate() + parseInt(data.validityDays));
            
            // Build HTML content
            pdfContainer.innerHTML = `
                <div style="font-family: 'Microsoft JhengHei', Arial, sans-serif;">
                    <!-- Header with Logo -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #d4a574; padding-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            ${logoBase64 ? `<img src="${logoBase64}" alt="LaLaRef Logo" style="width: 80px; height: 80px; object-fit: contain;">` : ''}
                            <div>
                                <h1 style="color: #d4a574; font-size: 36px; margin: 0;">LaLaRef</h1>
                                <h2 style="color: #5a4a3a; font-size: 24px; margin: 5px 0 0 0;">å ±åƒ¹å–® QUOTATION</h2>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 14px; margin-bottom: 5px;"><strong>å ±åƒ¹å–®ç·¨è™Ÿ:</strong> ${data.quoteNumber}</div>
                            <div style="font-size: 14px;"><strong>æ—¥æœŸ:</strong> ${data.quoteDate}</div>
                        </div>
                    </div>
                    
                    <!-- Customer Info -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #5a4a3a; font-size: 18px; margin-bottom: 10px;">å®¢æˆ¶è³‡æ–™ Bill To:</h3>
                        <div style="background: #f5e6d3; padding: 15px; border-radius: 10px;">
                            <div style="margin-bottom: 5px;"><strong>å®¢æˆ¶åç¨±:</strong> ${data.customerName}</div>
                            <div style="margin-bottom: 5px;"><strong>è¯çµ¡é›»è©±:</strong> ${data.customerPhone}</div>
                            ${data.customerEmail ? `<div style="margin-bottom: 5px;"><strong>é›»éƒµ:</strong> ${data.customerEmail}</div>` : ''}
                            ${data.customerAddress ? `<div><strong>åœ°å€:</strong> ${data.customerAddress}</div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Services Table -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #5a4a3a; font-size: 18px; margin-bottom: 10px;">æœå‹™é …ç›® Services:</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #d4a574; color: white;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #c89860;">æœå‹™åç¨±</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #c89860; width: 70px;">çƒè­‰æ•¸é‡</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #c89860; width: 70px;">å°æ™‚</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #c89860; width: 90px;">å–®åƒ¹<br>(HKD/å°æ™‚)</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #c89860; width: 100px;">å°è¨ˆ (HKD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.services.map(service => `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            ${service.name}
                                            ${service.notes ? `<br><span style="font-size: 12px; color: #666;">(${service.notes})</span>` : ''}
                                        </td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${service.quantity}</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${service.hours}</td>
                                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">$${formatMoney(service.price)}</td>
                                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">$${formatMoney(service.subtotal)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            * å°è¨ˆ = çƒè­‰æ•¸é‡ Ã— å°æ™‚ Ã— å–®åƒ¹
                        </div>
                    </div>
                    
                    <!-- Totals -->
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: flex-end;">
                            <div style="width: 300px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ddd;">
                                    <span>å°è¨ˆ Subtotal:</span>
                                    <span>HKD $${formatMoney(data.services.reduce((sum, s) => sum + parseFloat(s.subtotal), 0))}</span>
                                </div>
                                ${parseFloat(data.discount) > 0 ? `
                                    <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ddd;">
                                        <span>æŠ˜æ‰£ Discount:</span>
                                        <span>HKD -$${formatMoney(data.discount)}</span>
                                    </div>
                                ` : ''}
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #d4a574; color: white; font-size: 18px; font-weight: bold;">
                                    <span>ç¸½é‡‘é¡ Total:</span>
                                    <span>HKD $${formatMoney(data.totalAmount)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ddd; margin-top: 10px;">
                                    <span>è¨‚é‡‘ Deposit:</span>
                                    <span>HKD ${parseFloat(data.deposit) > 0 ? '-' : ''}$${formatMoney(data.deposit)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #f5e6d3; font-size: 16px; font-weight: bold; color: #5a4a3a;">
                                    <span>å°¾æ•¸ Balance Due:</span>
                                    <span>HKD $${formatMoney(data.balanceDue)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Terms -->
                    ${data.paymentTerms ? `
                        <div style="margin-bottom: 15px;">
                            <h3 style="color: #5a4a3a; font-size: 14px; margin-bottom: 6px;">ä»˜æ¬¾æ¢æ¬¾ Payment Terms:</h3>
                            <div style="background: #f5e6d3; padding: 10px; border-radius: 8px; white-space: pre-wrap; font-size: 11px; line-height: 1.4;">${data.paymentTerms}</div>
                        </div>
                    ` : ''}
                    
                    <!-- Notes -->
                    ${data.quoteNotes ? `
                        <div style="margin-bottom: 15px;">
                            <h3 style="color: #5a4a3a; font-size: 14px; margin-bottom: 6px;">å‚™è¨» Notes:</h3>
                            <div style="background: #f5e6d3; padding: 10px; border-radius: 8px; white-space: pre-wrap; font-size: 11px; line-height: 1.4;">${data.quoteNotes}</div>
                        </div>
                    ` : ''}
                    
                    <!-- Validity -->
                    <div style="margin-top: 15px; font-size: 10px; color: #666;">
                        <div>æ­¤å ±åƒ¹å–®æœ‰æ•ˆæœŸè‡³ (Valid until): ${validUntil.toISOString().split('T')[0]}</div>
                    </div>

                    <!-- Footer + Chop on same row -->
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; padding-top: 15px;">
                        <div style="text-align: center; font-size: 11px; color: #999; flex: 1;">
                            <div style="margin-bottom: 5px;"><strong>LaLaRef - å°ˆæ¥­ç±ƒçƒçƒè­‰æœå‹™</strong></div>
                            <div>Professional Basketball Referee Service</div>
                            <div style="margin-top: 5px;">é›»è©± Tel: +852 8482 8484 | ç¶²ç«™ Web: www.lalaref.com</div>
                        </div>
                        <div style="width: 90px; height: 90px; border: 3px solid #1a5276; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; transform: rotate(-8deg); opacity: 0.85; flex-shrink: 0;">
                            <div style="width: 78px; height: 78px; border: 1.5px solid #1a5276; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <div style="font-size: 10px; font-weight: bold; color: #1a5276; font-family: Microsoft JhengHei, sans-serif; letter-spacing: 1px;">LaLaRef</div>
                                <div style="font-size: 8px; font-weight: bold; color: #1a5276; font-family: Microsoft JhengHei, sans-serif; margin-top: 2px;">æ€¥å–®ç‹</div>
                                <div style="width: 30px; height: 1px; background: #1a5276; margin: 3px 0;"></div>
                                <div style="font-size: 6px; font-weight: bold; color: #1a5276; font-family: Microsoft JhengHei, sans-serif;">å°ˆæ¥­ç±ƒçƒçƒè­‰æœå‹™</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(pdfContainer);
            
            try {
                // Use html2canvas to render the HTML to canvas
                const canvas = await html2canvas(pdfContainer, {
                    scale: 1.5, // Reduced from 2 to balance quality and file size
                    useCORS: true,
                    allowTaint: false,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                // Create PDF from canvas
                const { jsPDF } = window.jspdf;
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                // Use JPEG with compression instead of PNG to reduce file size
                const imgData = canvas.toDataURL('image/jpeg', 0.85); // 85% quality JPEG
                
                // Add image to PDF - handle multi-page properly
                const pageHeight = 297; // A4 height in mm
                
                // If content fits on one page, just add it
                if (imgHeight <= pageHeight) {
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                } else {
                    // Multi-page content
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    // Add first page
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    // Add additional pages only if there's significant content left (more than 10mm)
                    while (heightLeft > 10) {
                        position += pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, -position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                }
                
                // Save PDF
                pdf.save('LaLaRef_å ±åƒ¹å–®_' + data.quoteNumber + '.pdf');
                showMessage('quotation-message', 'PDF å·²æˆåŠŸåŒ¯å‡º', 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showMessage('quotation-message', 'PDF åŒ¯å‡ºå¤±æ•—: ' + error.message, 'error');
            } finally {
                // Remove temporary element
                document.body.removeChild(pdfContainer);
            }
        }

        // Invoice Functions
        function loadQuotationForInvoice() {
            const quoteNum = document.getElementById('invoice-quote-number').value.trim();
            if (!quoteNum) {
                showMessage('invoice-message', 'è«‹è¼¸å…¥å ±åƒ¹å–®ç·¨è™Ÿ', 'error');
                return;
            }
            const saved = JSON.parse(localStorage.getItem('savedQuotations') || '{}');
            const data = saved[quoteNum];
            if (!data) {
                showMessage('invoice-message', 'æ‰¾ä¸åˆ°æ­¤å ±åƒ¹å–®ç·¨è™Ÿï¼Œè«‹å…ˆåœ¨å ±åƒ¹å–®åˆ†é ç”Ÿæˆ PDF', 'error');
                document.getElementById('invoice-preview').style.display = 'none';
                return;
            }
            document.getElementById('invoice-preview').style.display = 'block';
            document.getElementById('invoice-preview-content').innerHTML = `
                <div><strong>å®¢æˆ¶ï¼š</strong>${data.customerName}</div>
                <div><strong>é›»è©±ï¼š</strong>${data.customerPhone}</div>
                <div><strong>æœå‹™ï¼š</strong>${data.services.map(s => s.name).join(', ')}</div>
                <div><strong>ç¸½é‡‘é¡ï¼š</strong>HKD ${parseFloat(data.totalAmount).toFixed(2)}</div>
            `;
            showMessage('invoice-message', 'å ±åƒ¹å–®è³‡æ–™å·²è¼‰å…¥', 'success');
        }

        async function generateInvoicePDF() {
            const quoteNum = document.getElementById('invoice-quote-number').value.trim();
            const invoiceDate = document.getElementById('invoice-date').value;
            const paymentMethod = document.getElementById('invoice-payment-method').value;
            const invoiceNotes = document.getElementById('invoice-notes').value;
            
            if (!quoteNum || !invoiceDate) {
                showMessage('invoice-message', 'è«‹å¡«å¯«å ±åƒ¹å–®ç·¨è™ŸåŠç™¼ç¥¨æ—¥æœŸ', 'error');
                return;
            }
            const saved = JSON.parse(localStorage.getItem('savedQuotations') || '{}');
            const data = saved[quoteNum];
            if (!data) {
                showMessage('invoice-message', 'æ‰¾ä¸åˆ°æ­¤å ±åƒ¹å–®ç·¨è™Ÿ', 'error');
                return;
            }
            
            const invoiceNumber = 'INV' + quoteNum.replace('Q', '');
            
            const formatMoney = (amount) => parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            // Load logo
            let logoBase64 = '';
            try {
                const logoImg = new Image();
                await new Promise((resolve) => {
                    logoImg.onload = () => {
                        try {
                            const c = document.createElement('canvas');
                            c.width = logoImg.width; c.height = logoImg.height;
                            c.getContext('2d').drawImage(logoImg, 0, 0);
                            logoBase64 = c.toDataURL('image/jpeg');
                        } catch(e) {}
                        resolve();
                    };
                    logoImg.onerror = () => resolve();
                    logoImg.src = 'lalaref2.jpg';
                });
            } catch(e) {}
            
            const pdfContainer = document.createElement('div');
            pdfContainer.style.cssText = 'position:absolute;left:-9999px;width:800px;background:white;padding:40px;font-family:Arial,sans-serif;';
            
            pdfContainer.innerHTML = `
                <div style="font-family:'Microsoft JhengHei',Arial,sans-serif;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;border-bottom:3px solid #d4a574;padding-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:15px;">
                            ${logoBase64 ? `<img src="${logoBase64}" style="width:80px;height:80px;object-fit:contain;">` : ''}
                            <div>
                                <h1 style="color:#d4a574;font-size:36px;margin:0;">LaLaRef</h1>
                                <h2 style="color:#5a4a3a;font-size:24px;margin:5px 0 0 0;">ç™¼ç¥¨ INVOICE</h2>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:14px;margin-bottom:5px;"><strong>ç™¼ç¥¨ç·¨è™Ÿ:</strong> ${invoiceNumber}</div>
                            <div style="font-size:14px;margin-bottom:5px;"><strong>æ—¥æœŸ:</strong> ${invoiceDate}</div>
                            <div style="font-size:14px;"><strong>å ±åƒ¹å–®ç·¨è™Ÿ:</strong> ${quoteNum}</div>
                        </div>
                    </div>
                    <div style="margin-bottom:30px;">
                        <h3 style="color:#5a4a3a;font-size:18px;margin-bottom:10px;">å®¢æˆ¶è³‡æ–™ Bill To:</h3>
                        <div style="background:#f5e6d3;padding:15px;border-radius:10px;">
                            <div style="margin-bottom:5px;"><strong>å®¢æˆ¶åç¨±:</strong> ${data.customerName}</div>
                            <div style="margin-bottom:5px;"><strong>è¯çµ¡é›»è©±:</strong> ${data.customerPhone}</div>
                            ${data.customerEmail ? `<div style="margin-bottom:5px;"><strong>é›»éƒµ:</strong> ${data.customerEmail}</div>` : ''}
                            ${data.customerAddress ? `<div><strong>åœ°å€:</strong> ${data.customerAddress}</div>` : ''}
                        </div>
                    </div>
                    <div style="margin-bottom:30px;">
                        <h3 style="color:#5a4a3a;font-size:18px;margin-bottom:10px;">æœå‹™é …ç›® Services:</h3>
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:#d4a574;color:white;">
                                    <th style="padding:10px;text-align:left;border:1px solid #c89860;">æœå‹™åç¨±</th>
                                    <th style="padding:10px;text-align:center;border:1px solid #c89860;width:70px;">çƒè­‰æ•¸é‡</th>
                                    <th style="padding:10px;text-align:center;border:1px solid #c89860;width:70px;">å°æ™‚</th>
                                    <th style="padding:10px;text-align:right;border:1px solid #c89860;width:90px;">å–®åƒ¹<br>(HKD/å°æ™‚)</th>
                                    <th style="padding:10px;text-align:right;border:1px solid #c89860;width:100px;">å°è¨ˆ (HKD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.services.map(s => `
                                    <tr>
                                        <td style="padding:10px;border:1px solid #ddd;">${s.name}${s.notes ? `<br><span style="font-size:12px;color:#666;">(${s.notes})</span>` : ''}</td>
                                        <td style="padding:10px;text-align:center;border:1px solid #ddd;">${s.quantity}</td>
                                        <td style="padding:10px;text-align:center;border:1px solid #ddd;">${s.hours}</td>
                                        <td style="padding:10px;text-align:right;border:1px solid #ddd;">${formatMoney(s.price)}</td>
                                        <td style="padding:10px;text-align:right;border:1px solid #ddd;">${formatMoney(s.subtotal)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-bottom:30px;">
                        <div style="display:flex;justify-content:flex-end;">
                            <div style="width:300px;">
                                ${parseFloat(data.discount) > 0 ? `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #ddd;"><span>æŠ˜æ‰£ Discount:</span><span>HKD -${formatMoney(data.discount)}</span></div>` : ''}
                                <div style="display:flex;justify-content:space-between;padding:12px;background:#d4a574;color:white;font-size:18px;font-weight:bold;">
                                    <span>ç¸½é‡‘é¡ Total:</span><span>HKD ${formatMoney(data.totalAmount)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom:15px;">
                        <div style="font-size:13px;color:#5a4a3a;"><strong>ä»˜æ¬¾æ–¹å¼:</strong> ${paymentMethod}</div>
                        <div style="font-size:13px;color:#5a4a3a;margin-top:5px;"><strong>ç‹€æ…‹:</strong> <span style="color:#25d366;font-weight:bold;">å·²ä»˜æ¬¾ PAID</span></div>
                    </div>
                    ${invoiceNotes ? `<div style="margin-bottom:15px;"><h3 style="color:#5a4a3a;font-size:14px;margin-bottom:6px;">å‚™è¨» Notes:</h3><div style="background:#f5e6d3;padding:10px;border-radius:8px;white-space:pre-wrap;font-size:11px;">${invoiceNotes}</div></div>` : ''}
                    <div style="margin-top:20px;display:flex;justify-content:space-between;align-items:center;padding-top:15px;">
                        <div style="text-align:center;font-size:11px;color:#999;flex:1;">
                            <div style="margin-bottom:5px;"><strong>LaLaRef - å°ˆæ¥­ç±ƒçƒçƒè­‰æœå‹™</strong></div>
                            <div>Professional Basketball Referee Service</div>
                            <div style="margin-top:5px;">é›»è©± Tel: +852 8482 8484 | ç¶²ç«™ Web: www.lalaref.com</div>
                        </div>
                        <div style="width:90px;height:90px;border:3px solid #1a5276;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;transform:rotate(-8deg);opacity:0.85;flex-shrink:0;">
                            <div style="width:78px;height:78px;border:1.5px solid #1a5276;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                                <div style="font-size:10px;font-weight:bold;color:#1a5276;letter-spacing:1px;">LaLaRef</div>
                                <div style="font-size:8px;font-weight:bold;color:#1a5276;margin-top:2px;">æ€¥å–®ç‹</div>
                                <div style="width:30px;height:1px;background:#1a5276;margin:3px 0;"></div>
                                <div style="font-size:6px;font-weight:bold;color:#1a5276;">å°ˆæ¥­ç±ƒçƒçƒè­‰æœå‹™</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(pdfContainer);
            try {
                const canvas = await html2canvas(pdfContainer, { scale: 1.5, useCORS: true, allowTaint: false, logging: false, backgroundColor: '#ffffff' });
                const { jsPDF } = window.jspdf;
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/jpeg', 0.85);
                const pageHeight = 297;
                if (imgHeight <= pageHeight) {
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                } else {
                    let heightLeft = imgHeight, position = 0;
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft > 10) {
                        position += pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, -position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                }
                pdf.save('LaLaRef_ç™¼ç¥¨_' + invoiceNumber + '.pdf');
                showMessage('invoice-message', 'ç™¼ç¥¨ PDF å·²æˆåŠŸåŒ¯å‡º', 'success');
            } catch (error) {
                showMessage('invoice-message', 'ç™¼ç¥¨åŒ¯å‡ºå¤±æ•—: ' + error.message, 'error');
            } finally {
                document.body.removeChild(pdfContainer);
            }
        }
        // Message Generation Functions
        async function generateMessageFromCode() {
            const code = document.getElementById('msg-booking-code').value.trim();
            if (!code) {
                showMessage('message-tab-message', 'è«‹è¼¸å…¥é è¨‚ç·¨è™Ÿ', 'error');
                return;
            }
            if (!sheetUrl) {
                showMessage('message-tab-message', 'è«‹å…ˆåœ¨ã€Œè¨­å®šã€åˆ†é é…ç½® Google Sheets', 'error');
                return;
            }
            
            try {
                showMessage('message-tab-message', 'æ­£åœ¨è¼‰å…¥é è¨‚è³‡æ–™...', 'success');
                const response = await fetch(sheetUrl + '?code=' + encodeURIComponent(code));
                const result = await response.json();
                
                if (result.success && result.booking) {
                    const b = result.booking;
                    // Apply local edits if any
                    const bookingEdits = JSON.parse(localStorage.getItem('bookingEdits') || '{}');
                    const edits = bookingEdits[code];
                    if (edits) {
                        if (edits.venue !== undefined) b.venue = edits.venue;
                    }
                    
                    const msg = buildClientMessage(b);
                    document.getElementById('msg-output').value = msg;
                    document.getElementById('msg-output-area').style.display = 'block';
                    showMessage('message-tab-message', 'è¨Šæ¯å·²ç”Ÿæˆ', 'success');
                } else {
                    showMessage('message-tab-message', 'æ‰¾ä¸åˆ°æ­¤é è¨‚ç·¨è™Ÿ: ' + code, 'error');
                    document.getElementById('msg-output-area').style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching booking:', error);
                showMessage('message-tab-message', 'è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        function buildClientMessage(b) {
            const code = b.code || '';
            const matchDate = formatDate(b.matchDate);
            const matchTime = formatTime(b.matchTime);
            const matchEndTime = formatTime(b.matchEndTime);
            const venue = b.venue || 'N/A';
            const matchType = b.matchType || 'N/A';
            const refereeCount = b.refereeCount || 'N/A';
            const contactName = b.contactName || '';

            return `æ„Ÿè¬ä½ çš„é è¨‚ï¼ä»¥ä¸‹æ˜¯ä½ çš„è¨‚å–®ç¢ºèªè³‡æ–™ï¼š

ğŸ“‹ é è¨‚ç·¨è™Ÿï¼š${code}
ğŸ“… æ—¥æœŸï¼š${matchDate}
ğŸ• æ™‚é–“ï¼š${matchTime} - ${matchEndTime}
ğŸ“ åœ°é»ï¼š${venue}
ğŸ€ é¡å‹ï¼š${matchType}
ğŸ‘¨â€âš–ï¸ çƒè­‰æ•¸é‡ï¼š${refereeCount}

ä½ å¯ä»¥éš¨æ™‚é€éä»¥ä¸‹é€£çµæŸ¥è©¢é è¨‚è©³æƒ…ï¼š
ğŸ”— https://www.lalaref.com/track-booking.html?code=${code}

å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œæ­¡è¿éš¨æ™‚è¯çµ¡æˆ‘å€‘ã€‚
è¬è¬ï¼ğŸ€

LaLaRef æ€¥å–®ç‹
é›»è©±ï¼š+852 8482 8484
ç¶²ç«™ï¼šwww.lalaref.com`;
        }

        function copyMessageOutput() {
            const text = document.getElementById('msg-output').value;
            navigator.clipboard.writeText(text).then(() => {
                showMessage('message-tab-message', 'è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }).catch(() => {
                document.getElementById('msg-output').select();
                document.execCommand('copy');
                showMessage('message-tab-message', 'è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            });
        }

        function copyGreeting(num) {
            const text = document.getElementById('greeting-' + num).value;
            navigator.clipboard.writeText(text).then(() => {
                showMessage('message-tab-message', 'ç¯„æœ¬ ' + num + ' å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }).catch(() => {
                document.getElementById('greeting-' + num).select();
                document.execCommand('copy');
                showMessage('message-tab-message', 'ç¯„æœ¬ ' + num + ' å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            });
        }

        function generateClientMessage(code) {
            // Switch to message tab and pre-fill the code
            switchTab('message');
            document.getElementById('msg-booking-code').value = code;
            generateMessageFromCode();
        }

        function copyClientMessage(code) {
            // Quick copy from booking list - fetch and copy directly
            if (!sheetUrl) return;
            fetch(sheetUrl + '?code=' + encodeURIComponent(code))
                .then(r => r.json())
                .then(result => {
                    if (result.success && result.booking) {
                        const bookingEdits = JSON.parse(localStorage.getItem('bookingEdits') || '{}');
                        const edits = bookingEdits[code];
                        if (edits && edits.venue !== undefined) result.booking.venue = edits.venue;
                        const msg = buildClientMessage(result.booking);
                        navigator.clipboard.writeText(msg).then(() => {
                            alert('è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                        });
                    }
                });
        }
    </script>
</body>
</html>
