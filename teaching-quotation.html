<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å­¸èª²ç¨‹å ±åƒ¹å–® | LaLaRef æ€¥å–®ç‹</title>
    <link rel="icon" type="image/jpeg" href="lalaref2.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #f5e6d3 0%, #e8d4b8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: linear-gradient(145deg, #f0dcc8, #e8d4b8);
            border-radius: 30px;
            box-shadow: 20px 20px 40px rgba(0,0,0,0.15), -20px -20px 40px rgba(255,255,255,0.7);
        }

        .header h1 {
            font-size: 2.5em;
            color: #5a4a3a;
            margin-bottom: 10px;
        }

        .form-box {
            background: linear-gradient(145deg, #f0dcc8, #e8d4b8);
            padding: 40px;
            border-radius: 30px;
            box-shadow: 20px 20px 40px rgba(0,0,0,0.15), -20px -20px 40px rgba(255,255,255,0.7);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #5a4a3a;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(145deg, #f5e6d3, #ede0cc);
            border: none;
            border-radius: 20px;
            font-size: 1em;
            box-shadow: inset 8px 8px 16px rgba(0,0,0,0.1), inset -8px -8px 16px rgba(255,255,255,0.7);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 15px 30px;
            background: linear-gradient(145deg, #d4a574, #c89860);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.15), -10px -10px 20px rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 15px 15px 30px rgba(0,0,0,0.2), -15px -15px 30px rgba(255,255,255,0.6);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #f0dcc8, #e8d4b8);
            color: #5a4a3a;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .message {
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #25d366;
            color: white;
        }

        .message.error {
            background: #ff4444;
            color: white;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ€ æ•™å­¸èª²ç¨‹å ±åƒ¹å–®</h1>
            <p>ç±ƒçƒæ•™å­¸èª²ç¨‹å°ˆæ¥­å ±åƒ¹ç³»çµ±</p>
        </div>

        <div class="form-box">
            <h3 style="margin-bottom: 20px; color: #5a4a3a;">ğŸ€ å»ºç«‹æ•™å­¸èª²ç¨‹å ±åƒ¹å–®</h3>
            <div class="message" id="quotation-message"></div>
            
            <form id="quotation-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="quote-number">å ±åƒ¹å–®ç·¨è™Ÿ *</label>
                        <input type="text" id="quote-number" name="quoteNumber" placeholder="è‡ªå‹•ç”Ÿæˆ" readonly>
                    </div>
                    <div class="form-group">
                        <label for="quote-date">å ±åƒ¹æ—¥æœŸ *</label>
                        <input type="date" id="quote-date" name="quoteDate" required>
                    </div>
                </div>

                <h4 style="margin: 30px 0 15px; color: #5a4a3a;">å®¢æˆ¶è³‡æ–™</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="customer-name">å®¢æˆ¶å§“å/å­¸æ ¡/æ©Ÿæ§‹åç¨± *</label>
                        <input type="text" id="customer-name" name="customerName" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-phone">è¯çµ¡é›»è©± *</label>
                        <input type="tel" id="customer-phone" name="customerPhone" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="customer-email">é›»éƒµåœ°å€</label>
                    <input type="email" id="customer-email" name="customerEmail">
                </div>
                <div class="form-group">
                    <label for="customer-address">åœ°å€</label>
                    <input type="text" id="customer-address" name="customerAddress">
                </div>

                <h4 style="margin: 30px 0 15px; color: #5a4a3a;">æ•™å­¸èª²ç¨‹é …ç›®</h4>
                <div id="service-items">
                    <div class="service-item" style="background: #f5e6d3; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>èª²ç¨‹é¡å‹ *</label>
                                <select class="service-name" required onchange="handleServiceNameChange(this)">
                                    <option value="">è«‹é¸æ“‡</option>
                                    <option value="åŸºç¤ç±ƒçƒæŠ€å·§ç­">åŸºç¤ç±ƒçƒæŠ€å·§ç­</option>
                                    <option value="é€²éšç±ƒçƒè¨“ç·´ç­">é€²éšç±ƒçƒè¨“ç·´ç­</option>
                                    <option value="é’å°‘å¹´ç±ƒçƒåŸ¹è¨“">é’å°‘å¹´ç±ƒçƒåŸ¹è¨“</option>
                                    <option value="æˆäººç±ƒçƒè¨“ç·´">æˆäººç±ƒçƒè¨“ç·´</option>
                                    <option value="ä¸€å°ä¸€ç§äººæ•™ç·´">ä¸€å°ä¸€ç§äººæ•™ç·´</option>
                                    <option value="å°çµ„è¨“ç·´èª²ç¨‹">å°çµ„è¨“ç·´èª²ç¨‹ (4-8äºº)</option>
                                    <option value="å­¸æ ¡ç±ƒçƒèª²ç¨‹">å­¸æ ¡ç±ƒçƒèª²ç¨‹</option>
                                    <option value="ä¼æ¥­åœ˜éšŠè¨“ç·´">ä¼æ¥­åœ˜éšŠè¨“ç·´</option>
                                    <option value="æš‘æœŸç±ƒçƒè¨“ç·´ç‡Ÿ">æš‘æœŸç±ƒçƒè¨“ç·´ç‡Ÿ</option>
                                    <option value="é€±æœ«ç±ƒçƒç­">é€±æœ«ç±ƒçƒç­</option>
                                    <option value="æŠ•ç±ƒå°ˆé …è¨“ç·´">æŠ•ç±ƒå°ˆé …è¨“ç·´</option>
                                    <option value="é‹çƒæŠ€å·§è¨“ç·´">é‹çƒæŠ€å·§è¨“ç·´</option>
                                    <option value="é˜²å®ˆæŠ€è¡“è¨“ç·´">é˜²å®ˆæŠ€è¡“è¨“ç·´</option>
                                    <option value="é«”èƒ½è¨“ç·´èª²ç¨‹">é«”èƒ½è¨“ç·´èª²ç¨‹</option>
                                    <option value="æˆ°è¡“ç†è§£èª²ç¨‹">æˆ°è¡“ç†è§£èª²ç¨‹</option>
                                    <option value="å…¶ä»–">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
                                </select>
                                <input type="text" class="service-name-custom" placeholder="è«‹è¼¸å…¥èª²ç¨‹åç¨±" style="display: none; margin-top: 10px;">
                            </div>
                            <div class="form-group">
                                <label>å­¸å“¡äººæ•¸ *</label>
                                <input type="number" class="service-quantity" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label>èª²ç¨‹å ‚æ•¸ *</label>
                                <input type="number" class="service-sessions" min="1" value="8" required>
                            </div>
                            <div class="form-group">
                                <label>æ¯å ‚æ™‚é•· (å°æ™‚) *</label>
                                <input type="number" class="service-hours" min="0.5" step="0.5" value="1.5" required>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>å–®åƒ¹ (HKD/äºº/å ‚) *</label>
                                <input type="number" class="service-price" min="0" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label>å°è¨ˆ (HKD)</label>
                                <input type="number" class="service-subtotal" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>èª²ç¨‹å…§å®¹/å‚™è¨»</label>
                            <textarea class="service-notes" placeholder="ä¾‹å¦‚: åŒ…å«åŸºæœ¬é‹çƒã€æŠ•ç±ƒã€å‚³çƒæŠ€å·§ï¼Œæä¾›è¨“ç·´å™¨æ"></textarea>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addServiceItem()" style="margin-bottom: 20px;">â• æ–°å¢èª²ç¨‹é …ç›®</button>

                <h4 style="margin: 30px 0 15px; color: #5a4a3a;">é¡å¤–é …ç›® Additional Items</h4>
                <div id="additional-items">
                    <div class="additional-item" style="background: #f5e6d3; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>é …ç›®åç¨±</label>
                                <select class="additional-name" onchange="handleAdditionalNameChange(this)">
                                    <option value="">è«‹é¸æ“‡ï¼ˆå¯é¸ï¼‰</option>
                                    <option value="å ´åœ°ç§Ÿç”¨">å ´åœ°ç§Ÿç”¨</option>
                                    <option value="å™¨æç§Ÿç”¨">å™¨æç§Ÿç”¨</option>
                                    <option value="è¨“ç·´æœè£">è¨“ç·´æœè£</option>
                                    <option value="ä¿éšªè²»ç”¨">ä¿éšªè²»ç”¨</option>
                                    <option value="äº¤é€šè²»ç”¨">äº¤é€šè²»ç”¨</option>
                                    <option value="è­‰æ›¸è²»ç”¨">è­‰æ›¸è²»ç”¨</option>
                                    <option value="æ¯”è³½å ±åè²»">æ¯”è³½å ±åè²»</option>
                                    <option value="å…¶ä»–">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
                                </select>
                                <input type="text" class="additional-name-custom" placeholder="è«‹è¼¸å…¥é …ç›®åç¨±" style="display: none; margin-top: 10px;">
                            </div>
                            <div class="form-group">
                                <label>é‡‘é¡ (HKD)</label>
                                <input type="number" class="additional-amount" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>èªªæ˜</label>
                            <input type="text" class="additional-description" placeholder="ä¾‹å¦‚: æ¯æœˆå ´åœ°ç§Ÿç”¨è²»">
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addAdditionalItem()" style="margin-bottom: 20px;">â• æ–°å¢é¡å¤–é …ç›®</button>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="discount">æŠ˜æ‰£ (HKD)</label>
                        <input type="number" id="discount" name="discount" min="0" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label for="deposit">è¨‚é‡‘ (HKD)</label>
                        <input type="number" id="deposit" name="deposit" min="0" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label for="total-amount">ç¸½é‡‘é¡ (HKD) *</label>
                        <input type="number" id="total-amount" name="totalAmount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="balance-due">å°¾æ•¸ (HKD)</label>
                        <input type="number" id="balance-due" name="balanceDue" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label for="payment-terms">ä»˜æ¬¾æ¢æ¬¾</label>
                    <textarea id="payment-terms" name="paymentTerms">ä»˜æ¬¾æ–¹å¼ï¼š
1. PayMe
2. è½‰æ•¸å¿« (FPS)
3. éŠ€è¡Œè½‰å¸³
4. æ”¯ç¥¨

ä»˜æ¬¾æ™‚é–“ï¼š
- å ±åæ™‚éœ€ç¹³ä»˜ 50% è¨‚é‡‘
- èª²ç¨‹é–‹å§‹å‰ç¹³æ¸…é¤˜æ¬¾
- é•·æœŸèª²ç¨‹å¯æŒ‰æœˆåˆ†æœŸä»˜æ¬¾

é€€æ¬¾æ”¿ç­–ï¼š
- èª²ç¨‹é–‹å§‹å‰ 7 å¤©å–æ¶ˆï¼šå…¨é¡é€€æ¬¾
- èª²ç¨‹é–‹å§‹å‰ 3-7 å¤©å–æ¶ˆï¼šé€€é‚„ 50%
- èª²ç¨‹é–‹å§‹å¾Œä¸è¨­é€€æ¬¾
- å› å¤©æ°£æˆ–å ´åœ°å•é¡Œå–æ¶ˆèª²ç¨‹å°‡å®‰æ’è£œèª²

å…¶ä»–æ¢æ¬¾ï¼š
- å­¸å“¡éœ€è‡ªå‚™é‹å‹•æœè£åŠé‹å‹•é‹
- å¦‚æœ‰å‚·æ‚£è«‹æå‰å‘ŠçŸ¥æ•™ç·´
- ç¼ºå¸­èª²å ‚ä¸è¨­è£œèª²æˆ–é€€æ¬¾
- èª²ç¨‹åŒ…å«åŸºæœ¬è¨“ç·´å™¨æä½¿ç”¨</textarea>
                </div>

                <div class="form-group">
                    <label for="quote-notes">å‚™è¨»</label>
                    <textarea id="quote-notes" name="quoteNotes" placeholder="å…¶ä»–å‚™è¨»äº‹é …ï¼Œä¾‹å¦‚ï¼šèª²ç¨‹æ™‚é–“ã€åœ°é»ã€æ•™ç·´è³‡æ­·ç­‰"></textarea>
                </div>

                <div class="form-group">
                    <label for="validity-days">å ±åƒ¹æœ‰æ•ˆæœŸ (å¤©)</label>
                    <input type="number" id="validity-days" name="validityDays" value="30" min="1">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetQuotationForm()">ğŸ”„ é‡è¨­</button>
                    <button type="button" class="btn" onclick="previewQuotation()">ğŸ‘ï¸ é è¦½</button>
                    <button type="button" class="btn" onclick="generatePDF()">ğŸ“„ åŒ¯å‡º PDF</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function initQuotationForm() {
            const today = new Date();
            const dateStr = today.getFullYear() + 
                          String(today.getMonth() + 1).padStart(2, '0') + 
                          String(today.getDate()).padStart(2, '0');
            const randomNum = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            document.getElementById('quote-number').value = 'TC' + dateStr + randomNum;
            document.getElementById('quote-date').valueAsDate = new Date();
            updateCalculations();
        }

        function addServiceItem() {
            const container = document.getElementById('service-items');
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.style.cssText = 'background: #f5e6d3; padding: 20px; border-radius: 15px; margin-bottom: 15px; position: relative;';
            newItem.innerHTML = `
                <button type="button" onclick="removeServiceItem(this)" style="position: absolute; top: 10px; right: 10px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold;">Ã—</button>
                <div class="form-grid">
                    <div class="form-group">
                        <label>èª²ç¨‹é¡å‹ *</label>
                        <select class="service-name" required onchange="handleServiceNameChange(this)">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="åŸºç¤ç±ƒçƒæŠ€å·§ç­">åŸºç¤ç±ƒçƒæŠ€å·§ç­</option>
                            <option value="é€²éšç±ƒçƒè¨“ç·´ç­">é€²éšç±ƒçƒè¨“ç·´ç­</option>
                            <option value="é’å°‘å¹´ç±ƒçƒåŸ¹è¨“">é’å°‘å¹´ç±ƒçƒåŸ¹è¨“</option>
                            <option value="æˆäººç±ƒçƒè¨“ç·´">æˆäººç±ƒçƒè¨“ç·´</option>
                            <option value="ä¸€å°ä¸€ç§äººæ•™ç·´">ä¸€å°ä¸€ç§äººæ•™ç·´</option>
                            <option value="å°çµ„è¨“ç·´èª²ç¨‹">å°çµ„è¨“ç·´èª²ç¨‹ (4-8äºº)</option>
                            <option value="å­¸æ ¡ç±ƒçƒèª²ç¨‹">å­¸æ ¡ç±ƒçƒèª²ç¨‹</option>
                            <option value="ä¼æ¥­åœ˜éšŠè¨“ç·´">ä¼æ¥­åœ˜éšŠè¨“ç·´</option>
                            <option value="æš‘æœŸç±ƒçƒè¨“ç·´ç‡Ÿ">æš‘æœŸç±ƒçƒè¨“ç·´ç‡Ÿ</option>
                            <option value="é€±æœ«ç±ƒçƒç­">é€±æœ«ç±ƒçƒç­</option>
                            <option value="æŠ•ç±ƒå°ˆé …è¨“ç·´">æŠ•ç±ƒå°ˆé …è¨“ç·´</option>
                            <option value="é‹çƒæŠ€å·§è¨“ç·´">é‹çƒæŠ€å·§è¨“ç·´</option>
                            <option value="é˜²å®ˆæŠ€è¡“è¨“ç·´">é˜²å®ˆæŠ€è¡“è¨“ç·´</option>
                            <option value="é«”èƒ½è¨“ç·´èª²ç¨‹">é«”èƒ½è¨“ç·´èª²ç¨‹</option>
                            <option value="æˆ°è¡“ç†è§£èª²ç¨‹">æˆ°è¡“ç†è§£èª²ç¨‹</option>
                            <option value="å…¶ä»–">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
                        </select>
                        <input type="text" class="service-name-custom" placeholder="è«‹è¼¸å…¥èª²ç¨‹åç¨±" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>å­¸å“¡äººæ•¸ *</label>
                        <input type="number" class="service-quantity" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label>èª²ç¨‹å ‚æ•¸ *</label>
                        <input type="number" class="service-sessions" min="1" value="8" required>
                    </div>
                    <div class="form-group">
                        <label>æ¯å ‚æ™‚é•· (å°æ™‚) *</label>
                        <input type="number" class="service-hours" min="0.5" step="0.5" value="1.5" required>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>å–®åƒ¹ (HKD/äºº/å ‚) *</label>
                        <input type="number" class="service-price" min="0" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>å°è¨ˆ (HKD)</label>
                        <input type="number" class="service-subtotal" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>èª²ç¨‹å…§å®¹/å‚™è¨»</label>
                    <textarea class="service-notes" placeholder="ä¾‹å¦‚: åŒ…å«åŸºæœ¬é‹çƒã€æŠ•ç±ƒã€å‚³çƒæŠ€å·§ï¼Œæä¾›è¨“ç·´å™¨æ"></textarea>
                </div>
            `;
            container.appendChild(newItem);
            updateCalculations();
        }

        function handleServiceNameChange(selectElement) {
            const serviceItem = selectElement.closest('.service-item');
            const customInput = serviceItem.querySelector('.service-name-custom');
            
            if (selectElement.value === 'å…¶ä»–') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        function handleAdditionalNameChange(selectElement) {
            const additionalItem = selectElement.closest('.additional-item');
            const customInput = additionalItem.querySelector('.additional-name-custom');
            
            if (selectElement.value === 'å…¶ä»–') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        function addAdditionalItem() {
            const container = document.getElementById('additional-items');
            const newItem = document.createElement('div');
            newItem.className = 'additional-item';
            newItem.style.cssText = 'background: #f5e6d3; padding: 20px; border-radius: 15px; margin-bottom: 15px; position: relative;';
            newItem.innerHTML = `
                <button type="button" onclick="removeAdditionalItem(this)" style="position: absolute; top: 10px; right: 10px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold;">Ã—</button>
                <div class="form-grid">
                    <div class="form-group">
                        <label>é …ç›®åç¨±</label>
                        <select class="additional-name" onchange="handleAdditionalNameChange(this)">
                            <option value="">è«‹é¸æ“‡ï¼ˆå¯é¸ï¼‰</option>
                            <option value="å ´åœ°ç§Ÿç”¨">å ´åœ°ç§Ÿç”¨</option>
                            <option value="å™¨æç§Ÿç”¨">å™¨æç§Ÿç”¨</option>
                            <option value="è¨“ç·´æœè£">è¨“ç·´æœè£</option>
                            <option value="ä¿éšªè²»ç”¨">ä¿éšªè²»ç”¨</option>
                            <option value="äº¤é€šè²»ç”¨">äº¤é€šè²»ç”¨</option>
                            <option value="è­‰æ›¸è²»ç”¨">è­‰æ›¸è²»ç”¨</option>
                            <option value="æ¯”è³½å ±åè²»">æ¯”è³½å ±åè²»</option>
                            <option value="å…¶ä»–">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
                        </select>
                        <input type="text" class="additional-name-custom" placeholder="è«‹è¼¸å…¥é …ç›®åç¨±" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>é‡‘é¡ (HKD)</label>
                        <input type="number" class="additional-amount" min="0" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>èªªæ˜</label>
                    <input type="text" class="additional-description" placeholder="ä¾‹å¦‚: æ¯æœˆå ´åœ°ç§Ÿç”¨è²»">
                </div>
            `;
            container.appendChild(newItem);
            updateCalculations();
        }

        function removeAdditionalItem(btn) {
            btn.parentElement.remove();
            updateCalculations();
        }

        function removeServiceItem(btn) {
            btn.parentElement.remove();
            updateCalculations();
        }

        function updateCalculations() {
            document.querySelectorAll('.service-quantity, .service-sessions, .service-price').forEach(input => {
                input.removeEventListener('input', calculateSubtotals);
                input.addEventListener('input', calculateSubtotals);
            });
            
            document.querySelectorAll('.additional-amount').forEach(input => {
                input.removeEventListener('input', calculateTotal);
                input.addEventListener('input', calculateTotal);
            });
            
            document.getElementById('discount').removeEventListener('input', calculateTotal);
            document.getElementById('discount').addEventListener('input', calculateTotal);
            
            document.getElementById('deposit').removeEventListener('input', calculateBalance);
            document.getElementById('deposit').addEventListener('input', calculateBalance);
            
            calculateSubtotals();
        }

        function calculateSubtotals() {
            document.querySelectorAll('.service-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.service-quantity').value) || 0;
                const sessions = parseFloat(item.querySelector('.service-sessions').value) || 0;
                const price = parseFloat(item.querySelector('.service-price').value) || 0;
                const subtotal = quantity * sessions * price;
                item.querySelector('.service-subtotal').value = subtotal.toFixed(2);
            });
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.service-subtotal').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            // Add additional items
            document.querySelectorAll('.additional-amount').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const finalTotal = Math.max(0, total - discount);
            document.getElementById('total-amount').value = finalTotal.toFixed(2);
            
            calculateBalance();
        }

        function calculateBalance() {
            const total = parseFloat(document.getElementById('total-amount').value) || 0;
            const deposit = parseFloat(document.getElementById('deposit').value) || 0;
            const balance = Math.max(0, total - deposit);
            document.getElementById('balance-due').value = balance.toFixed(2);
        }

        function resetQuotationForm() {
            document.getElementById('quotation-form').reset();
            const container = document.getElementById('service-items');
            const items = container.querySelectorAll('.service-item');
            for (let i = 1; i < items.length; i++) {
                items[i].remove();
            }
            const additionalContainer = document.getElementById('additional-items');
            const additionalItems = additionalContainer.querySelectorAll('.additional-item');
            for (let i = 1; i < additionalItems.length; i++) {
                additionalItems[i].remove();
            }
            initQuotationForm();
        }

        function previewQuotation() {
            const data = getQuotationData();
            if (!data) return;
            
            alert('æ•™å­¸èª²ç¨‹å ±åƒ¹å–®é è¦½\n\n' + 
                  'å ±åƒ¹å–®ç·¨è™Ÿ: ' + data.quoteNumber + '\n' +
                  'å®¢æˆ¶: ' + data.customerName + '\n' +
                  'ç¸½é‡‘é¡: HKD ' + data.totalAmount + '\n\n' +
                  'è«‹é»æ“Šã€ŒåŒ¯å‡º PDFã€ç”Ÿæˆå®Œæ•´å ±åƒ¹å–®');
        }

        function getQuotationData() {
            const form = document.getElementById('quotation-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return null;
            }
            
            const services = [];
            document.querySelectorAll('.service-item').forEach(item => {
                const selectElement = item.querySelector('.service-name');
                const customInput = item.querySelector('.service-name-custom');
                let serviceName = selectElement.value;
                
                if (serviceName === 'å…¶ä»–') {
                    serviceName = customInput.value || 'å…¶ä»–èª²ç¨‹';
                }
                
                services.push({
                    name: serviceName,
                    quantity: item.querySelector('.service-quantity').value,
                    sessions: item.querySelector('.service-sessions').value,
                    hours: item.querySelector('.service-hours').value,
                    price: item.querySelector('.service-price').value,
                    subtotal: item.querySelector('.service-subtotal').value,
                    notes: item.querySelector('.service-notes').value
                });
            });
            
            const additionalItems = [];
            document.querySelectorAll('.additional-item').forEach(item => {
                const selectElement = item.querySelector('.additional-name');
                const customInput = item.querySelector('.additional-name-custom');
                const amountInput = item.querySelector('.additional-amount');
                const amount = parseFloat(amountInput.value) || 0;
                
                // Only include if there's an amount
                if (amount > 0) {
                    let itemName = selectElement.value;
                    if (itemName === 'å…¶ä»–') {
                        itemName = customInput.value || 'å…¶ä»–é …ç›®';
                    }
                    
                    if (itemName) {
                        additionalItems.push({
                            name: itemName,
                            amount: amount,
                            description: item.querySelector('.additional-description').value
                        });
                    }
                }
            });
            
            return {
                quoteNumber: document.getElementById('quote-number').value,
                quoteDate: document.getElementById('quote-date').value,
                customerName: document.getElementById('customer-name').value,
                customerPhone: document.getElementById('customer-phone').value,
                customerEmail: document.getElementById('customer-email').value,
                customerAddress: document.getElementById('customer-address').value,
                services: services,
                additionalItems: additionalItems,
                discount: document.getElementById('discount').value,
                deposit: document.getElementById('deposit').value,
                totalAmount: document.getElementById('total-amount').value,
                balanceDue: document.getElementById('balance-due').value,
                paymentTerms: document.getElementById('payment-terms').value,
                quoteNotes: document.getElementById('quote-notes').value,
                validityDays: document.getElementById('validity-days').value
            };
        }

        function showMessage(elementId, message, type) {
            const msgElement = document.getElementById(elementId);
            msgElement.textContent = message;
            msgElement.className = 'message show ' + type;
            
            setTimeout(() => {
                msgElement.classList.remove('show');
            }, 5000);
        }

        async function generatePDF() {
            const data = getQuotationData();
            if (!data) return;
            
            const formatMoney = (amount) => {
                return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            };
            
            let logoBase64 = '';
            try {
                const logoImg = new Image();
                await new Promise((resolve, reject) => {
                    logoImg.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = logoImg.width;
                            canvas.height = logoImg.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(logoImg, 0, 0);
                            logoBase64 = canvas.toDataURL('image/jpeg');
                            resolve();
                        } catch (err) {
                            console.warn('Canvas conversion failed:', err);
                            resolve();
                        }
                    };
                    logoImg.onerror = () => {
                        console.warn('Logo loading failed');
                        resolve();
                    };
                    logoImg.src = 'lalaref2.jpg';
                });
            } catch (error) {
                console.warn('Logo loading failed, continuing without logo:', error);
            }
            
            const pdfContainer = document.createElement('div');
            pdfContainer.style.cssText = 'position: absolute; left: -9999px; width: 800px; background: white; padding: 40px; font-family: Arial, sans-serif;';
            
            const validUntil = new Date(data.quoteDate);
            validUntil.setDate(validUntil.getDate() + parseInt(data.validityDays));
            
            pdfContainer.innerHTML = `
                <div style="font-family: 'Microsoft JhengHei', Arial, sans-serif;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #d4a574; padding-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            ${logoBase64 ? `<img src="${logoBase64}" alt="LaLaRef Logo" style="width: 80px; height: 80px; object-fit: contain;">` : ''}
                            <div>
                                <h1 style="color: #d4a574; font-size: 36px; margin: 0;">LaLaRef</h1>
                                <h2 style="color: #5a4a3a; font-size: 24px; margin: 5px 0 0 0;">æ•™å­¸èª²ç¨‹å ±åƒ¹å–®</h2>
                                <p style="color: #7a6a5a; font-size: 14px; margin: 5px 0 0 0;">Basketball Training Quotation</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 14px; margin-bottom: 5px;"><strong>å ±åƒ¹å–®ç·¨è™Ÿ:</strong> ${data.quoteNumber}</div>
                            <div style="font-size: 14px;"><strong>æ—¥æœŸ:</strong> ${data.quoteDate}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #5a4a3a; font-size: 18px; margin-bottom: 10px;">å®¢æˆ¶è³‡æ–™ Client Information:</h3>
                        <div style="background: #f5e6d3; padding: 15px; border-radius: 10px;">
                            <div style="margin-bottom: 5px;"><strong>å®¢æˆ¶åç¨±:</strong> ${data.customerName}</div>
                            <div style="margin-bottom: 5px;"><strong>è¯çµ¡é›»è©±:</strong> ${data.customerPhone}</div>
                            ${data.customerEmail ? `<div style="margin-bottom: 5px;"><strong>é›»éƒµ:</strong> ${data.customerEmail}</div>` : ''}
                            ${data.customerAddress ? `<div><strong>åœ°å€:</strong> ${data.customerAddress}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #5a4a3a; font-size: 18px; margin-bottom: 10px;">æ•™å­¸èª²ç¨‹é …ç›® Training Programs:</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #d4a574; color: white;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #c89860;">èª²ç¨‹åç¨±</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #c89860; width: 70px;">å­¸å“¡äººæ•¸</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #c89860; width: 70px;">å ‚æ•¸</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #c89860; width: 80px;">æ¯å ‚æ™‚é•·<br>(å°æ™‚)</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #c89860; width: 90px;">å–®åƒ¹<br>(HKD/äºº/å ‚)</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #c89860; width: 100px;">å°è¨ˆ (HKD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.services.map(service => `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            ${service.name}
                                            ${service.notes ? `<br><span style="font-size: 11px; color: #666;">${service.notes}</span>` : ''}
                                        </td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${service.quantity}</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${service.sessions}</td>
                                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${service.hours}</td>
                                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatMoney(service.price)}</td>
                                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatMoney(service.subtotal)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            * å°è¨ˆ = å­¸å“¡äººæ•¸ Ã— å ‚æ•¸ Ã— å–®åƒ¹
                        </div>
                    </div>
                    
                    ${data.additionalItems && data.additionalItems.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #5a4a3a; font-size: 18px; margin-bottom: 10px;">é¡å¤–é …ç›® Additional Items:</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #d4a574; color: white;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #c89860;">é …ç›®åç¨±</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #c89860; width: 150px;">é‡‘é¡ (HKD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.additionalItems.map(item => `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            ${item.name}
                                            ${item.description ? `<br><span style="font-size: 11px; color: #666;">${item.description}</span>` : ''}
                                        </td>
                                        <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatMoney(item.amount)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; justify-content: flex-end;">
                            <div style="width: 300px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ddd;">
                                    <span>èª²ç¨‹å°è¨ˆ Course Subtotal:</span>
                                    <span>HKD ${formatMoney(data.services.reduce((sum, s) => sum + parseFloat(s.subtotal), 0))}</span>
                                </div>
                                ${data.additionalItems && data.additionalItems.length > 0 ? `
                                    <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ddd;">
                                        <span>é¡å¤–é …ç›®å°è¨ˆ Additional Items:</span>
                                        <span>HKD ${formatMoney(data.additionalItems.reduce((sum, item) => sum + parseFloat(item.amount), 0))}</span>
                                    </div>
                                ` : ''}
                                ${parseFloat(data.discount) > 0 ? `
                                    <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ddd;">
                                        <span>æŠ˜æ‰£ Discount:</span>
                                        <span>HKD -${formatMoney(data.discount)}</span>
                                    </div>
                                ` : ''}
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #d4a574; color: white; font-size: 18px; font-weight: bold;">
                                    <span>ç¸½é‡‘é¡ Total:</span>
                                    <span>HKD ${formatMoney(data.totalAmount)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ddd; margin-top: 10px;">
                                    <span>è¨‚é‡‘ Deposit:</span>
                                    <span>HKD ${parseFloat(data.deposit) > 0 ? '-' : ''}${formatMoney(data.deposit)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: #f5e6d3; font-size: 16px; font-weight: bold; color: #5a4a3a;">
                                    <span>å°¾æ•¸ Balance Due:</span>
                                    <span>HKD ${formatMoney(data.balanceDue)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${data.paymentTerms ? `
                        <div style="margin-bottom: 15px;">
                            <h3 style="color: #5a4a3a; font-size: 14px; margin-bottom: 6px;">ä»˜æ¬¾æ¢æ¬¾ Payment Terms:</h3>
                            <div style="background: #f5e6d3; padding: 10px; border-radius: 8px; white-space: pre-wrap; font-size: 11px; line-height: 1.4;">${data.paymentTerms}</div>
                        </div>
                    ` : ''}
                    
                    ${data.quoteNotes ? `
                        <div style="margin-bottom: 15px;">
                            <h3 style="color: #5a4a3a; font-size: 14px; margin-bottom: 6px;">å‚™è¨» Notes:</h3>
                            <div style="background: #f5e6d3; padding: 10px; border-radius: 8px; white-space: pre-wrap; font-size: 11px; line-height: 1.4;">${data.quoteNotes}</div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px; font-size: 10px; color: #666;">
                        <div>æ­¤å ±åƒ¹å–®æœ‰æ•ˆæœŸè‡³ (Valid until): ${validUntil.toISOString().split('T')[0]}</div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; font-size: 11px; color: #999; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="margin-bottom: 5px;"><strong>LaLaRef - å°ˆæ¥­ç±ƒçƒæ•™å­¸æœå‹™</strong></div>
                        <div>Professional Basketball Training Service</div>
                        <div style="margin-top: 5px;">é›»è©± Tel: +852 8482 8484 | ç¶²ç«™ Web: www.lalaref.com</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(pdfContainer);
            
            try {
                const canvas = await html2canvas(pdfContainer, {
                    scale: 1.5,
                    useCORS: true,
                    allowTaint: false,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const { jsPDF } = window.jspdf;
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/jpeg', 0.85);
                
                const pageHeight = 297;
                
                if (imgHeight <= pageHeight) {
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                } else {
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft > 10) {
                        position += pageHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, -position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                }
                
                pdf.save('LaLaRef_æ•™å­¸èª²ç¨‹å ±åƒ¹å–®_' + data.quoteNumber + '.pdf');
                showMessage('quotation-message', 'PDF å·²æˆåŠŸåŒ¯å‡º', 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showMessage('quotation-message', 'PDF åŒ¯å‡ºå¤±æ•—: ' + error.message, 'error');
            } finally {
                document.body.removeChild(pdfContainer);
            }
        }

        window.addEventListener('DOMContentLoaded', initQuotationForm);
    </script>
</body>
</html>
